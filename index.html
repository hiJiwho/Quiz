<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON í€´ì¦ˆ ìƒì„±ê¸° (í’€ê¸° ë° ì¸ì‡„)</title>
    <!-- Tailwind CSS ë¡œë“œ --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ë³¸ ê¸€ê¼´ ì„¤ì • */
        body {
            font-family: 'Inter', 'Pretendard', sans-serif;
        }

        /* * ======================================
         * ì¸ì‡„ ì „ìš© ìŠ¤íƒ€ì¼ (A4 ìš©ì§€)
         * ======================================
         */
        @media print {
            body > #app-container {
                display: none;
            }
            body > #printable-area {
                display: block !important;
            }
            /* (ì‹ ê·œ) Aexport ëª¨ë“œì—ì„œ ë‹µì§€ ì—´ëŒ ì¸ì‡„ ì‹œ */
            #aexport-section {
                display: none !important;
            }
            #printable-area.aexport-print {
                display: block !importnat;
            }
            body > #aexport-section {
                display: none !important;
            }
            
            @page {
                size: A4;
                margin: 1.2cm;
            }

            #printable-area {
                font-size: 10pt;
                color: #000;
            }
            
            .print-column-container {
                column-count: 2;
                column-gap: 1.5cm;
            }

            .print-question-item {
                margin-bottom: 10px;
                page-break-inside: avoid;
            }

            .print-question-title {
                font-size: 1.1em;
                font-weight: bold;
                margin-bottom: 5px;
            }
            
            .print-question-svg {
                margin: 6px 0;
                max-width: 240px;
                margin-left: auto;
                margin-right: auto;
            }
            .print-question-svg svg {
                max-width: 100%;
                height: auto;
                border: 1px solid #ccc;
            }

            .print-options {
                list-style-type: none;
                list-style-position: inside;
                padding-left: 5px;
            }

            .print-option-item {
                display: flex;
                align-items: center;
                margin-bottom: 3px;
            }
            .print-option-svg {
                width: 26px;
                height: 26px;
                margin-left: 8px;
                border: 1px solid #ddd;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }
            .print-option-svg svg {
                width: 100%;
                height: 100%;
            }

            .print-answer {
                font-weight: bold;
                color: #333;
                margin-top: 5px;
            }
            
            .print-explanation {
                font-size: 0.95em;
                color: #444;
                margin-top: 4px;
                border-left: 2px solid #ddd;
                padding-left: 8px;
            }
            
            .print-quiz-title {
                text-align: center;
                font-size: 1.6em;
                font-weight: bold;
                margin-bottom: 0.8cm;
                margin-top: 0.2cm;
            }

            .print-answer-key-title {
                text-align: center;
                font-size: 1.4em;
                font-weight: bold;
                margin-top: 0.5cm;
                margin-bottom: 12px;
            }
            
            .print-quick-key-title {
                font-size: 1.2em;
                font-weight: bold;
                margin-top: 12px;
                margin-bottom: 8px;
                border-bottom: 1px solid #666;
                padding-bottom: 4px;
            }
            .print-quick-key-container {
                margin-bottom: 15px;
                page-break-inside: avoid;
                font-size: 10pt;
            }
            .print-quick-key-item {
                display: inline-block;
                margin: 0 10px 4px 0;
                font-weight: bold;
                min-width: 55px;
            }

            .print-detailed-explanation-title {
                font-size: 1.2em;
                font-weight: bold;
                margin-top: 20px;
                margin-bottom: 8px;
                border-bottom: 1px solid #666;
                padding-bottom: 4px;
            }

            .print-answer-item {
                margin-bottom: 8px;
                page-break-inside: avoid;
            }
        }

        /* * ======================================
         * ì•± UI ìŠ¤íƒ€ì¼
         * ======================================
         */

        #quiz-content-area {
            display: flex;
            flex-direction: column; /* ëª¨ë°”ì¼ ê¸°ë³¸: ìˆ˜ì§ ì •ë ¬ */
            gap: 24px;
            min-height: 400px;
        }
        
        #quiz-question-area {
            flex: 1 1 50%; 
            padding-right: 0;
            border-right: none;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        #quiz-options-area {
            flex: 1 1 50%; 
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 12px;
        }
        
        @media (min-width: 768px) { /* md: */
             #quiz-content-area {
                flex-direction: row;
             }
             #quiz-question-area {
                padding-right: 16px;
                border-right: 1px solid #e5e7eb;
             }
        }

        #timer-bar-container {
            width: 100%;
            background-color: #e0e7ff;
            border-radius: 4px;
            height: 8px;
            margin-top: 16px;
            overflow: hidden;
        }
        #timer-bar {
            height: 100%;
            background-color: #6366f1;
            width: 100%;
            transition: width 1s linear;
        }
        
        .html-option {
            display: flex;
            align-items: stretch;
            width: 100%;
            min-height: 56px;
            padding: 0;
            border: 1.5px solid #d1d5db;
            background-color: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            overflow: hidden;
        }
        
        .html-option:hover {
            background-color: #e5e7eb;
        }
        
        .option-content {
            flex-grow: 1;
            padding: 12px 16px;
            font-size: 16px;
            color: #111827;
            line-height: 1.5;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        .option-svg-wrapper {
            flex-shrink: 0;
            width: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1.5px solid #d1d5db;
            background-color: #e5e7eb;
            padding: 8px;
        }
        
        .option-svg-wrapper svg {
            width: 100%;
            height: 100%;
        }

        .html-option[data-state="correct"] {
            background-color: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }
        .html-option[data-state="wrong"] {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }
        .html-option[disabled] {
            cursor: default;
            opacity: 0.8;
        }
        .html-option[disabled]:hover {
            background-color: #f3f4f6;
        }
        .html-option[data-state="correct"][disabled]:hover {
            background-color: #dcfce7;
        }
        .html-option[data-state="wrong"][disabled]:hover {
            background-color: #fee2e2;
        }
        
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-10">

    <div id="app-container" class="max-w-5xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <!-- 1. JSON ì…ë ¥ ì„¹ì…˜ (ê¸°ë³¸) -->
        <div id="json-input-section" class="p-6 md:p-8">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">JSON í€´ì¦ˆ ìƒì„±ê¸°</h1>
            <p class="text-gray-600 mb-5">
                ì•„ë˜ í…ìŠ¤íŠ¸ ì˜ì—­ì— í€´ì¦ˆ ë¬¸ì œë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
                <br>
                ì˜ˆì œ JSONì„ ì°¸ê³ í•˜ì—¬ í˜•ì‹ì„ ë§ì¶”ê±°ë‚˜, ì§ì ‘ ìˆ˜ì •í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>

            <textarea id="json-input" rows="15" class="w-full p-4 border border-gray-300 rounded-lg font-mono text-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
            
            <p id="json-error" class="text-red-600 font-semibold mt-2 hidden"></p>

            <div class="flex flex-col gap-3 mt-4">
                <button id="load-json-btn" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-200">
                    ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
                <div class="grid grid-cols-3 gap-3">
                    <button id="reset-default-json-btn" class="w-full bg-gray-200 text-gray-700 px-5 py-3 rounded-lg hover:bg-gray-300 transition duration-200">
                        ì˜ˆì œ ì´ˆê¸°í™”
                    </button>
                    <button id="copy-json-btn" class="w-full bg-gray-200 text-gray-700 px-5 py-3 rounded-lg hover:bg-gray-300 transition duration-200">
                        ì˜ˆì œ ë³µì‚¬
                    </button>
                    <button id="clear-json-btn" class="w-full bg-red-500 text-white px-5 py-3 rounded-lg hover:bg-red-600 transition duration-200">
                        ì‚­ì œ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 2. ì•¡ì…˜ ì»¨íŠ¸ë¡¤ ì„¹ì…˜ (JSON ë¡œë“œ í›„) -->
        <div id="action-controls" class="p-6 md:p-8 border-t border-gray-200 hidden">
            <h2 id="quiz-title-display" class="text-2xl font-bold text-gray-800 mb-4 text-center"></h2>
            <div id="load-status" class="hidden mb-4 p-4 bg-green-100 text-green-800 rounded-lg">
                <span id="question-count" class="font-bold">0</span>ê°œì˜ ë¬¸ì œë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.
                <span id="timer-setting-display" class="block text-sm text-green-700 mt-1 hidden"></span>
            </div>
            
            <!-- í€´ì¦ˆ/ì¸ì‡„ ë²„íŠ¼ -->
            <div id="main-actions-container" class="grid grid-cols-1 gap-4">
                <button id="start-quiz-btn" class="w-full bg-green-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-green-700 transition">
                    í€´ì¦ˆ í’€ê¸° ì‹œì‘!
                </button>
                <div id="print-buttons-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="print-questions-btn" class="w-full bg-gray-700 text-white p-4 rounded-lg font-bold text-lg hover:bg-gray-800 transition">
                        ë¬¸ì œì§€ë§Œ ì¸ì‡„í•˜ê¸°
                    </button>
                    <button id="print-answers-btn" class="w-full bg-gray-800 text-white p-4 rounded-lg font-bold text-lg hover:bg-gray-900 transition">
                        ì •ë‹µ/í•´ì„¤ë§Œ ì¸ì‡„í•˜ê¸°
                    </button>
                </div>
            </div>
            
             <!-- ê³µìœ /ìˆ˜ì • ë²„íŠ¼ -->
             <div id="editor-buttons-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <button id="back-to-json-btn" class="w-full bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 transition">
                    JSON ìˆ˜ì •í•˜ê¸°
                </button>
                <button id="qexport-btn" class="w-full bg-blue-100 text-blue-700 p-3 rounded-lg hover:bg-blue-200 transition">
                    í€´ì¦ˆ ê³µìœ í•˜ê¸° (Qexport)
                </button>
                <button id="aexport-btn" class="w-full bg-indigo-100 text-indigo-700 p-3 rounded-lg hover:bg-indigo-200 transition">
                    ë‹µì§€ ê³µìœ í•˜ê¸° (Aexport)
                </button>
             </div>
        </div>
        
        <!-- 3. í€´ì¦ˆ í’€ê¸° ì„¹ì…˜ (íŒì—… ì—†ìŒ) -->
        <div id="quiz-section" class="p-6 md:p-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <span id="quiz-run-title" class="text-lg font-bold text-gray-800 hidden"></span>
                <span id="progress-text" class="text-lg font-semibold text-gray-700">ë¬¸ì œ 1 / 10</span>
                <button id="quit-quiz-btn" class="text-sm text-red-600 hover:text-red-800 font-medium">
                    ì²˜ìŒìœ¼ë¡œ
                </button>
            </div>
            <div id="timer-container" class="flex justify-between items-center mb-4 hidden">
                <span id="time-left-text" class="text-lg font-bold text-indigo-700">--:--</span>
                <div id="timer-bar-container">
                    <div id="timer-bar"></div>
                </div>
            </div>
            <div id="quiz-content-area" class="md:flex">
                <div id="quiz-question-area" class="mb-6 md:mb-0">
                    <h2 id="question-title" class="text-2xl font-bold text-gray-900 mb-4"></h2>
                    <div id="question-svg-container" class="my-5 flex justify-center hidden"></div>
                </div>
                <div id="quiz-options-area"></div>
            </div>
            <div class="mt-6 border-t border-gray-200 pt-6">
                <p id="feedback-text" class="text-xl font-bold"></p>
                <p id="explanation-text" class="mt-3 text-gray-700 bg-gray-100 p-4 rounded-md hidden"></p>
                <button id="next-question-btn" class="w-full bg-blue-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition mt-4 hidden">
                    ë‹¤ìŒ ë¬¸ì œë¡œ
                </button>
            </div>
        </div>

        <!-- 4. ìµœì¢… ê²°ê³¼ ì„¹ì…˜ (ë©”ì¸ì°½) -->
        <div id="results-section" class="p-6 md:p-10 text-center hidden">
            <h2 id="results-title" class="text-3xl font-bold text-gray-800 mb-4">í€´ì¦ˆ ì™„ë£Œ!</h2>
            <p class="text-xl text-gray-600 mb-6">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.</p>
            <div class="bg-blue-50 p-8 rounded-xl">
                <p class="text-lg text-blue-800">ì´ ë¬¸ì œ</p>
                <p id="total-questions-result" class="text-4xl font-extrabold text-blue-900 mb-4"></p>
                <p class="text-lg text-blue-800">ìµœì¢… ì ìˆ˜</p>
                <p id="final-score" class="text-6xl font-extrabold text-blue-900"></p>
            </div>
            <button id="restart-quiz-btn" class="w-full bg-blue-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition mt-8">
                ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
            <div id="wrong-answers-section" class="mt-10 text-left hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">í‹€ë¦° ë¬¸ì œ ë‹¤ì‹œ ë³´ê¸°</h3>
                <div id="wrong-answers-list" class="space-y-6"></div>
            </div>
        </div>

        <!-- 5. (ì‹ ê·œ) Qexport ì„¹ì…˜ -->
        <div id="qexport-section" class="p-6 md:p-8 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">í€´ì¦ˆ ê³µìœ  ë§í¬ ìƒì„±</h2>
            <p class="text-gray-600 mb-5">
                ë§í¬ë¥¼ ë°›ëŠ” ì¹œêµ¬ì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€ì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.
            </p>
            <div class="space-y-4">
                <div>
                    <label for="qexport-name" class="block text-sm font-medium text-gray-700">ë³´ë‚´ëŠ” ì‚¬ëŒ ì´ë¦„</label>
                    <input type="text" id="qexport-name" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="qexport-msg" class="block text-sm font-medium text-gray-700">ì¹œêµ¬ì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€</label>
                    <textarea id="qexport-msg" rows="3" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="ì´ ë¬¸ì œ í•œë²ˆ í’€ì–´ë´!"></textarea>
                </div>
                <div>
                    <button id="qexport-generate-btn" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg font-bold hover:bg-blue-700 transition">
                        ê³µìœ  ë§í¬ ìƒì„±í•˜ê¸°
                    </button>
                </div>
                <div id="qexport-result-container" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">ìƒì„±ëœ ë§í¬ (í´ë¦­í•˜ì—¬ ë³µì‚¬)</label>
                    <input type="text" id="qexport-result-url" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-pointer" readonly>
                </div>
            </div>
             <button id="qexport-back-btn" class="w-full bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 transition mt-6">
                ì·¨ì†Œ
            </button>
        </div>
        
        <!-- 6. (ì‹ ê·œ) Aexport ì„¹ì…˜ -->
        <div id="aexport-section" class="p-6 md:p-8 hidden">
            <h2 id="aexport-title" class="text-2xl font-bold text-gray-800 mb-4">ë‹µì§€ ë³´ê¸° / ì¸ì‡„</h2>
            <p class="text-gray-600 mb-6">
                í€´ì¦ˆì˜ ë‹µì§€ì™€ í•´ì„¤ì…ë‹ˆë‹¤.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <button id="aexport-print-btn" class="w-full bg-gray-700 text-white p-4 rounded-lg font-bold text-lg hover:bg-gray-800 transition">
                    ì´ ë‹µì§€ ì¸ì‡„í•˜ê¸°
                </button>
                 <button id="aexport-back-btn" class="w-full bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 transition">
                    ëŒì•„ê°€ê¸°
                </button>
            </div>
            <!-- ë‹µì§€ ë‚´ìš©ì´ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
            <div id="aexport-content" class="space-y-6"></div>
        </div>

        <!-- 7. (ì‹ ê·œ) Import ì„¹ì…˜ -->
        <div id="import-section" class="p-6 md:p-10 text-center hidden">
            <div class="bg-blue-50 p-8 rounded-xl">
                <h2 id="import-name" class="text-3xl font-bold text-gray-800 mb-2"></h2>
                <p class="text-xl text-gray-600 mb-6">ë‹˜ì´ ë³´ë‚¸ í€´ì¦ˆì…ë‹ˆë‹¤.</p>
                <p id="import-msg" class="text-lg text-blue-800 bg-white p-4 rounded-md shadow-inner min-h-[50px]"></p>
            </div>
            
            <div class="grid grid-cols-1 gap-4 mt-8">
                <button id="import-start-btn" class="w-full bg-green-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-green-700 transition">
                    í€´ì¦ˆ í’€ê¸°
                </button>
                <button id="import-print-btn" class="w-full bg-gray-700 text-white p-4 rounded-lg font-bold text-lg hover:bg-gray-800 transition">
                    ì¸ì‡„í•˜ê¸°
                </button>
                <button id="import-share-btn" class="w-full bg-blue-100 text-blue-700 p-3 rounded-lg hover:bg-blue-200 transition">
                    ì´ í€´ì¦ˆ ì¬ê³µìœ í•˜ê¸°
                </button>
            </div>
        </div>

    </div>

    <!-- 
      ======================================
      ì¸ì‡„ ì „ìš© HTML ì˜ì—­ (í‰ì†Œì—ëŠ” ì•ˆ ë³´ì„)
      ======================================
    --><div id="printable-area" class="hidden">
        <!-- JSê°€ ì´ê³³ì— ì¸ì‡„ìš© ì»¨í…ì¸ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤ --></div>


    <!-- 
      ======================================
      ìë°”ìŠ¤í¬ë¦½íŠ¸ ë¡œì§
      ======================================
    --><script>
        // --- ì˜ˆì œ JSON ë°ì´í„° (ë¬¸ìì—´ í˜•íƒœ) ---
        // PDFì˜ 5ë¬¸ì œë¡œ DEFAULT_QUIZ_JSONì„ êµì²´
        const DEFAULT_QUIZ_JSON = `
{
    "title": "ì¤‘í•™êµ ê³¼í•™ ì‹¬í™” í‰ê°€ (5, 6, 7ë‹¨ì› ì—°ê³„)",
    "totalTimeLimitSeconds": 300,
    "questions": [
        {
            "question": "ë³¼ë¡ ë Œì¦ˆë¥¼ ì´ìš©í•˜ì—¬ ë¬¼ì²´ Aì˜ ì‹¤ìƒì„ ìŠ¤í¬ë¦°ì— ë§ºì—ˆë‹¤. ë¬¼ì²´ Aë¥¼ ë Œì¦ˆì˜ ì´ˆì ê±°ë¦¬(f)ì˜ 2ë°° ì§€ì (2f)ì—ì„œ ë Œì¦ˆë¡œë¶€í„° ë©€ë¦¬ ì´ë™ì‹œì¼°ì„ ë•Œ(ì—¬ì „íˆ ì‹¤ìƒì´ ë§ºíˆëŠ” ë²”ìœ„ ë‚´), ìƒì˜ ë³€í™”ë¡œ ì˜³ì€ ê²ƒì€?",
            "svgImage": "<svg viewBox='0 0 200 60' xmlns='http://www.w3.org/2000/svg' class='w-full max-w-sm border rounded-md'><path d='M 10 30 H 190' stroke='gray' stroke-dasharray='4 2' /><path d='M 100 10 V 50' stroke='black' stroke-width='2' /><path d='M 100 10 Q 110 30 100 50' stroke='black' stroke-width='2' fill='none' /><path d='M 100 10 Q 90 30 100 50' stroke='black' stroke-width='2' fill='none' /><path d='M 50 25 V 30 H 48 L 50 25 L 52 30 H 50' stroke='black' stroke-width='1.5' fill='none' /><text x='50' y='22' text-anchor='middle' font-size='10'>A</text><text x='50' y='38' text-anchor='middle' font-size='10'>2f</text><text x='150' y='38' text-anchor='middle' font-size='10'>2f</text><text x='100' y='8' text-anchor='middle' font-size='10'>ë Œì¦ˆ</text></svg>",
            "options": [
                { "text": "ì‹¤ìƒì˜ í¬ê¸°ëŠ” ì»¤ì§€ê³ , ë Œì¦ˆë¡œë¶€í„° ë©€ì–´ì§„ë‹¤." },
                { "text": "ì‹¤ìƒì˜ í¬ê¸°ëŠ” ì‘ì•„ì§€ê³ , ë Œì¦ˆì— ê°€ê¹Œì›Œì§„ë‹¤." },
                { "text": "ì‹¤ìƒì˜ í¬ê¸°ëŠ” ë³€í•˜ì§€ ì•Šê³ , ë Œì¦ˆì— ê°€ê¹Œì›Œì§„ë‹¤." },
                { "text": "ì‹¤ìƒì˜ í¬ê¸°ëŠ” ì‘ì•„ì§€ê³ , ë Œì¦ˆë¡œë¶€í„° ë©€ì–´ì§„ë‹¤." },
                { "text": "ì‹¤ìƒì˜ í¬ê¸°ëŠ” ì»¤ì§€ê³ , ë Œì¦ˆì— ê°€ê¹Œì›Œì§„ë‹¤." }
            ],
            "answerIndex": 1,
            "explanation": "ë³¼ë¡ ë Œì¦ˆì—ì„œ ë¬¼ì²´ê°€ 2f(ì´ˆì ê±°ë¦¬ì˜ 2ë°°)ë³´ë‹¤ ë©€ì–´ì§€ë©´, ì‹¤ìƒì€ ë Œì¦ˆ ë°˜ëŒ€í¸ì˜ fì™€ 2f ì‚¬ì´(ë Œì¦ˆì— ê°€ê¹Œì›Œì§)ì— ë§ºíˆë©° ê·¸ í¬ê¸°ëŠ” ë¬¼ì²´ë³´ë‹¤ ì‘ì•„ì§‘ë‹ˆë‹¤."
        },
        {
            "question": "ì§ˆëŸ‰ 2kgì¸ ë¬¼ì²´ê°€ ì§ì„  ìš´ë™ì„ í•œë‹¤. 0ì´ˆë¶€í„° 4ì´ˆê¹Œì§€ì˜ ì†ë„-ì‹œê°„ ê·¸ë˜í”„ê°€ ì˜¤ë¥¸ìª½ê³¼ ê°™ì„ ë•Œ, 0ì´ˆë¶€í„° 4ì´ˆê¹Œì§€ ë¬¼ì²´ì— ì‘ìš©í•œ ì•Œì§œí˜ì˜ í‰ê·  í¬ê¸°(N)ëŠ”?",
            "svgImage": "<svg viewBox='0 0 100 70' xmlns='http://www.w3.org/2000/svg' class='w-full max-w-xs border rounded-md'><path d='M 10 60 H 90 M 10 60 V 10' stroke='black' stroke-width='1' /><text x='5' y='15' font-size='8'>ì†ë„(m/s)</text><text x='85' y='65' font-size='8'>ì‹œê°„(s)</text><path d='M 10 58 L 10 60' stroke='black' stroke-width='1' /><text x='10' y='68' text-anchor='middle' font-size='8'>0</text><path d='M 50 58 L 50 60' stroke='black' stroke-width='1' /><text x='50' y='68' text-anchor='middle' font-size='8'>2</text><path d='M 80 58 L 80 60' stroke='black' stroke-width='1' /><text x='80' y='68' text-anchor='middle' font-size='8'>4</text><path d='M 10 20 L 12 20' stroke='black' stroke-width='1' /><text x='7' y='23' text-anchor='end' font-size='8'>4</text><path d='M 10 20 H 50' stroke='gray' stroke-dasharray='2 2' /><path d='M 50 20 V 60' stroke='gray' stroke-dasharray='2 2' /><path d='M 80 20 V 60' stroke='gray' stroke-dasharray='2 2' /><path d='M 10 60 L 50 20 L 80 20' stroke='red' stroke-width='2' fill='none'/></svg>",
            "options": [
                { "text": "0 N" },
                { "text": "1 N" },
                { "text": "2 N" },
                { "text": "3 N" },
                { "text": "4 N" }
            ],
            "answerIndex": 2,
            "explanation": "í‰ê·  ì•Œì§œí˜ F = m * a (ì§ˆëŸ‰ * í‰ê·  ê°€ì†ë„). í‰ê·  ê°€ì†ë„ a = (ë‚˜ì¤‘ ì†ë„ - ì²˜ìŒ ì†ë„) / (ì´ ì‹œê°„) = (4 m/s - 0 m/s) / 4s = 1 m/sÂ². ë”°ë¼ì„œ F = 2kg * 1 m/sÂ² = 2 N ì…ë‹ˆë‹¤."
        },
        {
            "question": "ì›ì†Œ AëŠ” 3ì£¼ê¸° 1ì¡±, ì›ì†Œ BëŠ” 2ì£¼ê¸° 17ì¡±ì´ë‹¤. ì´ ë‘ ì›ì†Œê°€ ê²°í•©í•˜ì—¬ ìƒì„±ëœ í™”í•©ë¬¼ ABì— ëŒ€í•œ ì„¤ëª…ìœ¼ë¡œ ì˜³ì§€ ì•Šì€ ê²ƒì€?",
            "options": [
                { "text": "í™”í•©ë¬¼ ABëŠ” ì´ì˜¨ ê²°í•© ë¬¼ì§ˆì´ë‹¤." },
                { "text": "AëŠ” ì–‘ì´ì˜¨ì´ ë˜ê¸° ì‰½ê³ , BëŠ” ìŒì´ì˜¨ì´ ë˜ê¸° ì‰½ë‹¤." },
                { "text": "í™”í•©ë¬¼ ABëŠ” ìƒì˜¨ì—ì„œ ë‹¨ë‹¨í•œ ê³ ì²´ ìƒíƒœë¡œ ì¡´ì¬í•œë‹¤." },
                { "text": "í™”í•©ë¬¼ ABëŠ” ìˆ˜ìš©ì•¡ ìƒíƒœì—ì„œ ì „ê¸° ì „ë„ì„±ì´ ì—†ë‹¤." },
                { "text": "A ì›ì†ŒëŠ” ì „ìë¥¼ 1ê°œ ìƒê³ , B ì›ì†ŒëŠ” ì „ìë¥¼ 1ê°œ ì–»ì–´ ì•ˆì •í•œ ì „ì ë°°ì¹˜ë¥¼ ì´ë£¬ë‹¤." }
            ],
            "answerIndex": 3,
            "explanation": "AëŠ” 3ì£¼ê¸° 1ì¡±(ì˜ˆ: ë‚˜íŠ¸ë¥¨, Na)ì´ê³  BëŠ” 2ì£¼ê¸° 17ì¡±(ì˜ˆ: í”Œë£¨ì˜¤ë¦°, F)ì´ë¯€ë¡œ, ê¸ˆì†ê³¼ ë¹„ê¸ˆì†ì˜ ê²°í•©ì¸ ì´ì˜¨ ê²°í•© ë¬¼ì§ˆ(ì˜ˆ: NaF)ì„ í˜•ì„±í•©ë‹ˆë‹¤. ì´ì˜¨ ê²°í•© ë¬¼ì§ˆì€ ê³ ì²´ì—ì„œ ì „ê¸°ê°€ í†µí•˜ì§€ ì•Šì§€ë§Œ, ë¬¼ì— ë…¹ì•„ ì´ì˜¨í™”ë˜ë©´(ìˆ˜ìš©ì•¡ ìƒíƒœ) ì „ê¸° ì „ë„ì„±ì´ ìˆìŠµë‹ˆë‹¤."
        },
        {
            "question": "ë‹¤ìŒ ë‘ í™”í•™ ë°˜ì‘ê³¼ ê´€ë ¨ëœ ì—ë„ˆì§€ ë³€í™”ì— ëŒ€í•œ ì‹¬í™” ë¶„ì„ìœ¼ë¡œ ì˜³ì€ ê²ƒì„ ëª¨ë‘ ê³ ë¥¸ ê²ƒì€? (ë‹¨, ëª¨ë“  ë°˜ì‘ì€ í‘œì¤€ ìƒíƒœì—ì„œ ì§„í–‰ëœë‹¤.) [ë°˜ì‘ 1] 2Hâ‚‚(g) + Oâ‚‚(g) â†’ 2Hâ‚‚O(l) + Qâ‚ (Qâ‚>0) [ë°˜ì‘ 2] CaCOâ‚ƒ(s) + Qâ‚‚ â†’ CaO(s) + COâ‚‚(g) (Qâ‚‚>0)",
            "options": [
                { "text": "ã„±" },
                { "text": "ã„´" },
                { "text": "ã„±, ã„´" },
                { "text": "ã„´, ã„·" },
                { "text": "ã„±, ã„´, ã„·" }
            ],
            "answerIndex": 2,
            "explanation": "ã„±: Qâ‚>0ì€ ë°˜ì‘ ì‹œ ì—´(Qâ‚)ì´ ë°©ì¶œëœë‹¤ëŠ” ëœ»ì´ë¯€ë¡œ ë°œì—´ ë°˜ì‘ì…ë‹ˆë‹¤. ë°œì—´ ë°˜ì‘ì—ì„œëŠ” ìƒì„±ë¬¼ì˜ ì—ë„ˆì§€ ì´í•©ì´ ë°˜ì‘ë¬¼ë³´ë‹¤ ë‚®ì•„ ë” ì•ˆì •í•©ë‹ˆë‹¤. (ì˜³ìŒ) ã„´: Qâ‚‚>0ì€ ë°˜ì‘ ì‹œ ì—´(Qâ‚‚)ì´ í¡ìˆ˜ëœë‹¤ëŠ” ëœ»ì´ë¯€ë¡œ í¡ì—´ ë°˜ì‘ì…ë‹ˆë‹¤. í¡ì—´ ë°˜ì‘ì€ ì™¸ë¶€ì—ì„œ ì—ë„ˆì§€ë¥¼ ê³µê¸‰ë°›ì•„ì•¼ ì¼ì–´ë‚©ë‹ˆë‹¤. (ì˜³ìŒ) ã„·: ë°˜ì‘ 1ì˜ ì—­ë°˜ì‘(ë¬¼ì˜ ì „ê¸°ë¶„í•´)ì€ ì—ë„ˆì§€ë¥¼ í¡ìˆ˜í•˜ëŠ” í¡ì—´ ë°˜ì‘ì…ë‹ˆë‹¤. ë°˜ì‘ 2ì˜ ì—­ë°˜ì‘ì€ ì—ë„ˆì§€ë¥¼ ë°©ì¶œí•˜ëŠ” ë°œì—´ ë°˜ì‘ì…ë‹ˆë‹¤. (í‹€ë¦¼)"
        },
        {
            "question": "í•´ì–‘íŒì´ ëŒ€ë¥™íŒ ì•„ë˜ë¡œ ì„­ì…í•˜ëŠ” ìˆ˜ë ´í˜• ê²½ê³„(ì„­ì…ëŒ€) ê·¼ì²˜ì—ì„œ, ì¼ë¶€ ì§€ì—­ì—ì„œ ì§€ì§„íŒŒì˜ ì†ë„ê°€ ì£¼ë³€ ë§¨í‹€ë³´ë‹¤ ë¹„ì •ìƒì ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì¸¡ì •ë˜ëŠ” í˜„ìƒì´ ê´€ì°°ë˜ì—ˆë‹¤. ì´ í˜„ìƒìœ¼ë¡œë¶€í„° ì¶”ë¡ í•  ìˆ˜ ìˆëŠ” ì§€í•˜ êµ¬ì¡°ì— ëŒ€í•œ ì„¤ëª…ìœ¼ë¡œ ê°€ì¥ ì ì ˆí•œ ê²ƒì€?",
            "svgImage": "<svg viewBox='0 0 150 70' xmlns='http://www.w3.org/2000/svg' class='w-full max-w-sm border rounded-md'><rect x='0' y='20' width='100' height='50' fill='#aaccff' /><text x='50' y='45' text-anchor='middle' font-size='10' fill='black'>í•´ì–‘íŒ</text><path d='M 80 20 L 120 60 L 150 60 L 150 20 Z' fill='#d2b48c' /><text x='125' y='40' text-anchor='middle' font-size='10' fill='black'>ëŒ€ë¥™íŒ</text><path d='M 100 20 L 115 35' stroke='black' stroke-width='2' /><text x='107' y='18' font-size='8'>ì„­ì…ëŒ€</text><rect x='80' y='50' width='50' height='20' fill='#ffcc88' opacity='0.7' /><text x='105' y='62' font-size='8' fill='red'>ê³ ì†ë„ëŒ€(ë¹ ë¦„)</text><text x='30' y='62' font-size='8'>ì£¼ë³€ ë§¨í‹€(ëŠë¦¼)</text></svg>",
            "options": [
                { "text": "ì„­ì…ëœ íŒ ì£¼ë³€ì€ ì£¼ë³€ ë§¨í‹€ë³´ë‹¤ ë°€ë„ê°€ ë†’ê³  ì˜¨ë„ê°€ ë‚®ì•„ ì§€ì§„íŒŒì˜ ì†ë„ê°€ ì¦ê°€í•˜ëŠ” ê³ ì†ë„ëŒ€ê°€ í˜•ì„±ëœë‹¤." },
                { "text": "ì„­ì…ëœ íŒ ì£¼ë³€ì€ ë§ˆê·¸ë§ˆ í™œë™ìœ¼ë¡œ ì¸í•´ ì˜¨ë„ê°€ ë†’ì•„ì ¸ ì§€ì§„íŒŒì˜ ì†ë„ê°€ ê°ì†Œí•˜ëŠ” ì €ì†ë„ëŒ€ê°€ í˜•ì„±ëœë‹¤." },
                { "text": "íŒì´ ì¹¨ê°•í•˜ë©´ì„œ ìƒë¶€ ë§¨í‹€ê³¼ì˜ ë§ˆì°°ì´ ì‹¬í•´ì ¸ PíŒŒì™€ SíŒŒì˜ ì†ë„ ì°¨ì´ê°€ ê¸‰ê²©íˆ ì¤„ì–´ë“ ë‹¤." },
                { "text": "ì„­ì…ëŒ€ í•˜ë¶€ì—ì„œëŠ” í•µê³¼ì˜ ê²½ê³„ê°€ ê°€ê¹Œì›Œì ¸ ì§€ì§„íŒŒê°€ ì•¡ì²´ ìƒíƒœì˜ ì™¸í•µì„ í†µê³¼í•˜ê²Œ ëœë‹¤." },
                { "text": "ì§€ì§„íŒŒì˜ ì†ë„ ì¦ê°€ëŠ” íŒì˜ ê²½ê³„ê°€ í™•ì¥í•˜ëŠ” ë°œì‚°í˜• ê²½ê³„ì—ì„œ ì£¼ë¡œ ë‚˜íƒ€ë‚˜ëŠ” í˜„ìƒì´ë‹¤." }
            ],
            "answerIndex": 0,
            "explanation": "ì„­ì…í•˜ëŠ” í•´ì–‘íŒì€ ì°¨ê°‘ê³  ë°€ë„ê°€ ë†’ìŠµë‹ˆë‹¤. ë°˜ë©´ ì£¼ë³€ì˜ ë§¨í‹€ì€ ëœ¨ê²ê³  ìƒëŒ€ì ìœ¼ë¡œ ë°€ë„ê°€ ë‚®ìŠµë‹ˆë‹¤. ì§€ì§„íŒŒëŠ” ì°¨ê°‘ê³  ë°€ë„ê°€ ë†’ì€ ë¬¼ì§ˆì„ ë” ë¹ ë¥´ê²Œ í†µê³¼í•˜ë¯€ë¡œ, ì„­ì…í•˜ëŠ” íŒì€ 'ê³ ì†ë„ëŒ€(High-velocity zone)'ë¥¼ í˜•ì„±í•©ë‹ˆë‹¤. (ì €ì†ë„ëŒ€ëŠ” ì£¼ë¡œ ë§¨í‹€ì´ ë¶€ë¶„ì ìœ¼ë¡œ ë…¹ì•„ìˆëŠ” ì—°ì•½ê¶Œ ë“±ì—ì„œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.)"
        }
    ]
}
`;

        // --- ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ---
        let db;
        const DB_NAME = 'QuizAppDB';
        const STORE_NAME = 'Quizzes';
        const DB_STATE_KEY = 'appState';
        
        let g_currentMode = null; // (ì‹ ê·œ) í˜„ì¬ ì‹¤í–‰ ëª¨ë“œ (Quiz, Print ë“±)
        let currentQuiz = {}; 
        let currentQuestionIndex = 0;
        let score = 0;
        let isAnswered = false; 
        let timerInterval; 
        let timeLeft; 
        let wrongAnswers = []; 

        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const appContainer = document.getElementById('app-container');
        const jsonInputSection = document.getElementById('json-input-section'); 
        const jsonInput = document.getElementById('json-input');
        const jsonError = document.getElementById('json-error');
        const loadJsonBtn = document.getElementById('load-json-btn');
        const resetDefaultJsonBtn = document.getElementById('reset-default-json-btn');
        const copyJsonBtn = document.getElementById('copy-json-btn');
        const clearJsonBtn = document.getElementById('clear-json-btn'); 
        
        const actionControls = document.getElementById('action-controls');
        const quizTitleDisplay = document.getElementById('quiz-title-display'); 
        const loadStatus = document.getElementById('load-status');
        const questionCount = document.getElementById('question-count');
        const timerSettingDisplay = document.getElementById('timer-setting-display'); 
        
        const mainActionsContainer = document.getElementById('main-actions-container');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const printButtonsContainer = document.getElementById('print-buttons-container');
        const printQuestionsBtn = document.getElementById('print-questions-btn');
        const printAnswersBtn = document.getElementById('print-answers-btn');
        const editorButtonsContainer = document.getElementById('editor-buttons-container');
        const backToJsonBtn = document.getElementById('back-to-json-btn');
        const qexportBtn = document.getElementById('qexport-btn');
        const aexportBtn = document.getElementById('aexport-btn');
        
        const quizSection = document.getElementById('quiz-section');
        const quizRunTitle = document.getElementById('quiz-run-title'); 
        const quitQuizBtn = document.getElementById('quit-quiz-btn');
        const progressText = document.getElementById('progress-text');
        const timerContainer = document.getElementById('timer-container'); 
        const timeLeftText = document.getElementById('time-left-text'); 
        const timerBar = document.getElementById('timer-bar'); 
        const timerBarContainer = document.getElementById('timer-bar-container'); 
        
        const questionTitle = document.getElementById('question-title');
        const svgContainer = document.getElementById('question-svg-container');
        const optionsArea = document.getElementById('quiz-options-area');
        
        const feedbackText = document.getElementById('feedback-text');
        const explanationText = document.getElementById('explanation-text');
        const nextQuestionBtn = document.getElementById('next-question-btn');

        const resultsSection = document.getElementById('results-section');
        const resultsTitle = document.getElementById('results-title'); 
        const totalQuestionsResult = document.getElementById('total-questions-result');
        const finalScore = document.getElementById('final-score');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        const wrongAnswersSection = document.getElementById('wrong-answers-section'); 
        const wrongAnswersList = document.getElementById('wrong-answers-list'); 

        const printableArea = document.getElementById('printable-area');
        
        const qexportSection = document.getElementById('qexport-section');
        const qexportName = document.getElementById('qexport-name');
        const qexportMsg = document.getElementById('qexport-msg');
        const qexportGenerateBtn = document.getElementById('qexport-generate-btn');
        const qexportResultContainer = document.getElementById('qexport-result-container');
        const qexportResultUrl = document.getElementById('qexport-result-url');
        const qexportBackBtn = document.getElementById('qexport-back-btn');

        const aexportSection = document.getElementById('aexport-section');
        const aexportTitle = document.getElementById('aexport-title');
        const aexportPrintBtn = document.getElementById('aexport-print-btn');
        const aexportBackBtn = document.getElementById('aexport-back-btn');
        const aexportContent = document.getElementById('aexport-content');

        const importSection = document.getElementById('import-section');
        const importName = document.getElementById('import-name');
        const importMsg = document.getElementById('import-msg');
        const importStartBtn = document.getElementById('import-start-btn');
        const importPrintBtn = document.getElementById('import-print-btn');
        const importShareBtn = document.getElementById('import-share-btn');


        // --- IndexedDB í—¬í¼ í•¨ìˆ˜ ---

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("IndexedDB initialized");
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        function saveStateToDB(id, state) {
            return new Promise((resolve, reject) => {
                if (!db) return reject("DB not initialized");
                try {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.put({ id: id, ...state });
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) { reject(error); }
            });
        }

        function loadStateFromDB(id) {
            return new Promise((resolve, reject) => {
                if (!db) return reject("DB not initialized");
                try {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(id);
                    request.onsuccess = (event) => {
                        if (event.target.result) resolve(event.target.result);
                        else reject("State not found in DB");
                    };
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) { reject(error); }
            });
        }

        function deleteStateFromDB(id) {
            return new Promise((resolve, reject) => {
                if (!db) return resolve();
                try {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) { reject(error); }
            });
        }


        // --- UI ì„¹ì…˜ í‘œì‹œ í—¬í¼ ---
        function showSection(sectionId) {
            [jsonInputSection, actionControls, quizSection, resultsSection, qexportSection, aexportSection, importSection].forEach(section => {
                if (!section) return; 
                if (section.id === sectionId) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            });
        }


        // --- í•¨ìˆ˜ ì •ì˜ ---

        /** 1. JSON ë¶ˆëŸ¬ì˜¤ê¸° ë° ìœ íš¨ì„± ê²€ì‚¬ */
        function loadJsonData(mode = null) {
            try {
                const rawJson = jsonInput.value;
                const parsedData = JSON.parse(rawJson); 

                if (typeof parsedData !== 'object' || parsedData === null || !Array.isArray(parsedData.questions)) {
                    throw new Error("JSON ë°ì´í„°ëŠ” ìµœìƒìœ„ ê°ì²´ì—¬ì•¼ í•˜ë©°, 'questions' ë°°ì—´ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.");
                }
                if (parsedData.questions.length === 0) {
                    throw new Error("'questions' ë°°ì—´ì€ ë¹„ì–´ìˆì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.");
                }
                if (parsedData.title && typeof parsedData.title !== 'string') {
                    throw new Error("'title' ì†ì„±ì€ ë¬¸ìì—´(string)ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                }
                if (parsedData.totalTimeLimitSeconds && typeof parsedData.totalTimeLimitSeconds !== 'number') {
                    throw new Error("'totalTimeLimitSeconds' ì†ì„±ì€ ìˆ«ì(number)ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                }

                for (const item of parsedData.questions) {
                    if (!item.question || !Array.isArray(item.options) || item.options.length === 0 || typeof item.answerIndex !== 'number') {
                        throw new Error("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (question, options, answerIndex í•„ìš”)");
                    }
                    for (const opt of item.options) {
                        if (typeof opt !== 'object' || opt === null || typeof opt.text !== 'string') {
                            throw new Error("ê° 'options' í•­ëª©ì€ 'text' ì†ì„±ì„ ê°€ì§„ ê°ì²´(object)ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                        }
                    }
                }

                // ì„±ê³µ
                currentQuiz = parsedData; 
                jsonError.classList.add('hidden');
                
                questionCount.textContent = currentQuiz.questions.length; 
                loadStatus.classList.remove('hidden'); 
                
                quizTitleDisplay.textContent = currentQuiz.title || "ì œëª© ì—†ëŠ” í€´ì¦ˆ";
                resultsTitle.textContent = currentQuiz.title ? `${currentQuiz.title} í€´ì¦ˆ ì™„ë£Œ!` : "í€´ì¦ˆ ì™„ë£Œ!";
                quizRunTitle.textContent = currentQuiz.title || "í€´ì¦ˆ í’€ê¸°";
                quizRunTitle.classList.remove('hidden');

                if (currentQuiz.totalTimeLimitSeconds) {
                    const minutes = Math.floor(currentQuiz.totalTimeLimitSeconds / 60);
                    const seconds = currentQuiz.totalTimeLimitSeconds % 60;
                    timerSettingDisplay.textContent = `(ì´ ì œí•œ ì‹œê°„: ${minutes}:${seconds.toString().padStart(2, '0')})`;
                    timerSettingDisplay.classList.remove('hidden');
                } else {
                    timerSettingDisplay.classList.add('hidden');
                }

                showSection('action-controls');
                
                g_currentMode = mode; // (ìˆ˜ì •) ì „ì—­ ëª¨ë“œ ë³€ìˆ˜ ì„¤ì •

                if (mode === 'Quiz') { // í€´ì¦ˆ í’€ê¸°ë§Œ
                    printButtonsContainer.classList.add('hidden');
                    editorButtonsContainer.classList.add('hidden');
                } else if (mode === 'Print') { // ì¸ì‡„ë§Œ
                    startQuizBtn.classList.add('hidden');
                    editorButtonsContainer.classList.add('hidden');
                } else { // 0 ë˜ëŠ” ì—†ìŒ (ëª¨ë‘ í‘œì‹œ)
                    startQuizBtn.classList.remove('hidden');
                    printButtonsContainer.classList.remove('hidden');
                    editorButtonsContainer.classList.remove('hidden');
                }
                
            } catch (error) {
                currentQuiz = {}; 
                jsonError.textContent = `JSON ì˜¤ë¥˜: ${error.message}`;
                jsonError.classList.remove('hidden');
                showSection('json-input-section');
            }
        }

        /** íƒ€ì´ë¨¸ í‘œì‹œ í—¬í¼ (MM:SS) */
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            if (timeLeftText) {
                timeLeftText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }


        /** 2. í€´ì¦ˆ ì‹œì‘ (íŒì—… ì—†ìŒ) */
        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            wrongAnswers = []; 
            
            showSection('quiz-section');

            // (ìˆ˜ì •) ì „ì—­ ëª¨ë“œ ë³€ìˆ˜(g_currentMode)ë¥¼ í™•ì¸
            if (g_currentMode === 'Quiz') {
                if (quitQuizBtn) quitQuizBtn.classList.add('hidden');
            } else {
                 if (quitQuizBtn) quitQuizBtn.classList.remove('hidden');
            }
            
            clearInterval(timerInterval);
            if (currentQuiz.totalTimeLimitSeconds) {
                timeLeft = currentQuiz.totalTimeLimitSeconds;
                timerContainer.classList.remove('hidden');
                updateTimerDisplay();
                
                if (timerBar) {
                    timerBar.style.transition = 'none';
                    timerBar.style.width = '100%';
                    setTimeout(() => {
                        timerBar.style.transition = `width ${timeLeft}s linear`;
                        timerBar.style.width = '0%';
                    }, 100);
                }

                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        showResults(true); // ì‹œê°„ ì´ˆê³¼
                    }
                }, 1000);
            } else {
                timerContainer.classList.add('hidden');
            }
            
            loadQuestion();
        }

        /** 3. ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸° (HTML ë³´ê¸° ë²„íŠ¼) */
        function loadQuestion() {
            isAnswered = false;
            feedbackText.textContent = '';
            explanationText.textContent = '';
            explanationText.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            
            const currentQuestion = currentQuiz.questions[currentQuestionIndex]; 
            
            progressText.textContent = `ë¬¸ì œ ${currentQuestionIndex + 1} / ${currentQuiz.questions.length}`;
            questionTitle.textContent = currentQuestion.question;
            
            if (currentQuestion.svgImage) {
                svgContainer.innerHTML = currentQuestion.svgImage;
                svgContainer.classList.remove('hidden');
            } else {
                svgContainer.innerHTML = '';
                svgContainer.classList.add('hidden');
            }

            optionsArea.innerHTML = '';
            currentQuestion.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'html-option';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'option-content';
                contentDiv.textContent = `(${index + 1}) ${option.text}`;
                button.appendChild(contentDiv);

                if (option.svgImage) {
                    const svgWrapper = document.createElement('div');
                    svgWrapper.className = 'option-svg-wrapper';
                    svgWrapper.innerHTML = option.svgImage;
                    const embeddedSvg = svgWrapper.querySelector('svg');
                    if (embeddedSvg) {
                        embeddedSvg.setAttribute('width', '100%');
                        embeddedSvg.setAttribute('height', '100%');
                    }
                    button.appendChild(svgWrapper);
                }
                
                button.addEventListener('click', () => selectAnswer(button, index));
                optionsArea.appendChild(button);
            });
        }

        /** 4. ë‹µì•ˆ ì„ íƒ (íƒ€ì´ë¨¸ ì¼ì‹œ ì •ì§€) */
        function selectAnswer(selectedButton, selectedIndex) {
            if (isAnswered) return;
            
            clearInterval(timerInterval); 
            
            if(currentQuiz.totalTimeLimitSeconds && timerBar && timerBarContainer) {
                try {
                    const currentWidth = timerBar.getBoundingClientRect().width;
                    const containerWidth = timerBarContainer.getBoundingClientRect().width;
                    timerBar.style.transition = 'none';
                    if (containerWidth > 0) {
                        timerBar.style.width = `${(currentWidth / containerWidth) * 100}%`;
                    }
                } catch(e) { console.warn("Timer bar pause failed:", e.message); }
            }

            isAnswered = true;
            const currentQuestion = currentQuiz.questions[currentQuestionIndex]; 
            const correctIndex = currentQuestion.answerIndex;
            const allOptionButtons = optionsArea.querySelectorAll('.html-option');
            
            if (selectedIndex === correctIndex) {
                score++;
                selectedButton.setAttribute('data-state', 'correct');
                feedbackText.textContent = 'ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!';
                feedbackText.style.color = 'green';
            } else {
                wrongAnswers.push(currentQuestionIndex); 
                selectedButton.setAttribute('data-state', 'wrong');
                feedbackText.textContent = 'âŒ í‹€ë ¸ìŠµë‹ˆë‹¤.';
                feedbackText.style.color = 'red';
            }

            const correctButton = allOptionButtons[correctIndex];
            if (correctButton) correctButton.setAttribute('data-state', 'correct');
            
            if (currentQuestion.explanation) {
                explanationText.textContent = `í’€ì´: ${currentQuestion.explanation}`;
                explanationText.classList.remove('hidden');
            }

            nextQuestionBtn.classList.remove('hidden');
            allOptionButtons.forEach(button => button.disabled = true);
        }

        /** 5. ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™ (íƒ€ì´ë¨¸ ì¬ì‹œì‘) */
        function goToNextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuiz.questions.length) { 
                if (currentQuiz.totalTimeLimitSeconds && timeLeft > 0) {
                    updateTimerDisplay();
                    if (timerBar) {
                        timerBar.style.transition = 'none';
                        setTimeout(() => {
                            timerBar.style.transition = `width ${timeLeft}s linear`;
                            timerBar.style.width = '0%';
                        }, 100);
                    }
                    timerInterval = setInterval(() => {
                        timeLeft--;
                        updateTimerDisplay();
                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                            showResults(true); // ì‹œê°„ ì´ˆê³¼
                        }
                    }, 1000);
                }
                loadQuestion();
            } else {
                showResults(false); // ì‹œê°„ ì´ˆê³¼ ì•„ë‹˜
            }
        }

        /** 6. ê²°ê³¼ í™”ë©´ í‘œì‹œ (íŒì—… ë¡œì§ ì œê±°) */
        function showResults(isTimeOut = false) {
            clearInterval(timerInterval); 
            
            // íŒì—… ë¡œì§ ì œê±°ë¨
            
            showSection('results-section');
            
            const title = currentQuiz.title || "í€´ì¦ˆ";
            if (isTimeOut) {
                resultsTitle.textContent = "â° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤!";
            } else {
                resultsTitle.textContent = `${title} í€´ì¦ˆ ì™„ë£Œ!`;
            }
            
            totalQuestionsResult.textContent = `${currentQuiz.questions.length} ë¬¸ì œ`; 
            finalScore.textContent = `${score} ê°œ`;
            renderWrongAnswers(currentQuiz, wrongAnswers);
            
            // (ì‹ ê·œ) ê²°ê³¼ í™”ë©´ì˜ 'ì²˜ìŒìœ¼ë¡œ' ë²„íŠ¼ì´ ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì‘ë™
            restartQuizBtn.removeEventListener('click', resetApp);
            restartQuizBtn.removeEventListener('click', backToJsonEditor);
            
            if (g_currentMode === 'Quiz' || g_currentMode === 'Print') {
                // Quiz/Print ëª¨ë“œì˜€ìœ¼ë©´ 'ì²˜ìŒìœ¼ë¡œ' ë²„íŠ¼ì´ ì•„ì˜ˆ ì•±ì„ ë¦¬ì…‹í•˜ë„ë¡ í•¨
                restartQuizBtn.addEventListener('click', resetApp);
            } else {
                // ì¼ë°˜ ëª¨ë“œì˜€ìœ¼ë©´ JSON í¸ì§‘ê¸°ë¡œ ëŒì•„ê°
                restartQuizBtn.addEventListener('click', backToJsonEditor);
            }
        }

        /** í‹€ë¦° ë¬¸ì œ í•´ì„¤ ë Œë”ë§ (ì¬ì‚¬ìš©) */
        function renderWrongAnswers(quizData, wrongIdxArray) {
            wrongAnswersList.innerHTML = ''; 
            if (wrongIdxArray.length > 0) {
                wrongAnswersSection.classList.remove('hidden');
                
                wrongIdxArray.forEach(wrongIndex => {
                    const question = quizData.questions[wrongIndex];
                    if (!question) return;
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'p-4 bg-gray-50 rounded-lg border border-gray-200';
                    
                    const qTitle = document.createElement('h4');
                    qTitle.className = 'text-lg font-bold text-gray-800 mb-2';
                    qTitle.textContent = `[ë¬¸ì œ ${wrongIndex + 1}] ${question.question}`;
                    itemDiv.appendChild(qTitle);
                    
                    const answer = document.createElement('p');
                    answer.className = 'text-md font-semibold text-green-700';
                    const correctOptionText = question.options[question.answerIndex].text;
                    answer.textContent = `ì •ë‹µ: (${question.answerIndex + 1}) ${correctOptionText}`;
                    itemDiv.appendChild(answer);
                    
                    if (question.explanation) {
                        const explanation = document.createElement('p');
                        explanation.className = 'text-md text-gray-700 mt-2 pt-2 border-t border-gray-200';
                        explanation.textContent = `í’€ì´: ${question.explanation}`;
                        itemDiv.appendChild(explanation);
                    }
                    
                    wrongAnswersList.appendChild(itemDiv);
                });

            } else {
                wrongAnswersList.innerHTML = '';
                wrongAnswersSection.classList.add('hidden');
                if (resultsSection.contains(wrongAnswersList)) {
                     const noWrongMsg = document.createElement('p');
                     noWrongMsg.className = "text-green-600 font-bold text-center text-lg";
                     noWrongMsg.textContent = "ğŸ‰ ëª¨ë“  ë¬¸ì œë¥¼ ë§í˜”ìŠµë‹ˆë‹¤! ğŸ‰";
                     wrongAnswersList.appendChild(noWrongMsg);
                     wrongAnswersSection.classList.remove('hidden');
                }
            }
        }
        
        /** ë‹µì§€ ë°ì´í„° ë Œë”ë§ (Aexportìš©) */
        function renderAnswersOnly(quizData) {
            aexportContent.innerHTML = '';
            aexportTitle.textContent = (quizData.title ? `${quizData.title} ` : "") + 'ì •ë‹µ ë° í’€ì´';

            const quickKeyTitle = document.createElement('h3');
            quickKeyTitle.className = 'text-xl font-bold text-gray-800 mb-2 border-b pb-2';
            quickKeyTitle.textContent = 'ë¹ ë¥¸ ì •ë‹µ';
            aexportContent.appendChild(quickKeyTitle);

            const quickKeyContainer = document.createElement('div');
            quickKeyContainer.className = 'flex flex-wrap gap-x-4 gap-y-2 mb-6';
            
            quizData.questions.forEach((question, index) => {
                const keyItem = document.createElement('span');
                keyItem.className = 'font-bold text-gray-700 text-lg';
                keyItem.textContent = `${index + 1}. (${question.answerIndex + 1})`;
                quickKeyContainer.appendChild(keyItem);
            });
            aexportContent.appendChild(quickKeyContainer);

            const detailedTitle = document.createElement('h3');
            detailedTitle.className = 'text-xl font-bold text-gray-800 mb-4 border-b pb-2';
            detailedTitle.textContent = 'ìƒì„¸ í’€ì´';
            aexportContent.appendChild(detailedTitle);

            const detailsContainer = document.createElement('div');
            detailsContainer.className = 'space-y-6';
            
            quizData.questions.forEach((question, index) => {
                 const itemDiv = document.createElement('div');
                 itemDiv.className = 'p-4 bg-gray-50 rounded-lg border border-gray-200';
                    
                 const qTitle = document.createElement('h4');
                 qTitle.className = 'text-lg font-bold text-gray-800 mb-2';
                 qTitle.textContent = `[ë¬¸ì œ ${index + 1}]`;
                 itemDiv.appendChild(qTitle);
                    
                 const answer = document.createElement('p');
                 answer.className = 'text-md font-semibold text-green-700';
                 const correctOptionText = question.options[question.answerIndex].text;
                 answer.textContent = `ì •ë‹µ: (${question.answerIndex + 1}) ${correctOptionText}`;
                 itemDiv.appendChild(answer);
                    
                 if (question.explanation) {
                     const explanation = document.createElement('p');
                     explanation.className = 'text-md text-gray-700 mt-2 pt-2 border-t border-gray-200';
                     explanation.textContent = `í’€ì´: ${question.explanation}`;
                     itemDiv.appendChild(explanation);
                 }
                 detailsContainer.appendChild(itemDiv);
            });
            aexportContent.appendChild(detailsContainer);
        }


        /** 7. ì•± ì´ˆê¸°í™” (ì²˜ìŒìœ¼ë¡œ) */
        async function resetApp() {
            // íŒì—… ë¡œì§ ì œê±°

            try {
                await deleteStateFromDB(DB_STATE_KEY);
            } catch (error) {
                console.error("Failed to clear quiz data from DB:", error);
            }

            currentQuiz = {}; 
            currentQuestionIndex = 0;
            score = 0;
            clearInterval(timerInterval); 
            wrongAnswers = []; 
            g_currentMode = null; // (ì‹ ê·œ) ì „ì—­ ëª¨ë“œ ë¦¬ì…‹
            
            showSection('json-input-section');
            wrongAnswersList.innerHTML = ''; 
            
            // (ìˆ˜ì •) URLì„ ì™„ì „í•œ / ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ìƒˆë¡œê³ ì¹¨)
            if (window.location.pathname !== '/' || window.location.search || window.location.hash) {
                 window.location.href = window.location.pathname;
            }
           
            jsonInput.value = DEFAULT_QUIZ_JSON;
            jsonError.classList.add('hidden');
        }


        /** 9a. ë¬¸ì œì§€ë§Œ ì¸ì‡„í•˜ê¸° */
        function printQuestionsOnly() {
            printableArea.innerHTML = '';
            
            const quizTitle = document.createElement('h1');
            quizTitle.innerHTML = currentQuiz.title || "í€´ì¦ˆ ë¬¸ì œì§€";
            quizTitle.className = 'print-quiz-title';
            printableArea.appendChild(quizTitle);

            const questionsContainer = document.createElement('div');
            questionsContainer.className = 'print-column-container';

            currentQuiz.questions.forEach((question, index) => { 
                const itemDiv = document.createElement('div');
                itemDiv.className = 'print-question-item';

                const qTitle = document.createElement('h2');
                qTitle.className = 'print-question-title';
                qTitle.textContent = `${index + 1}. ${question.question}`;
                itemDiv.appendChild(qTitle);

                if (question.svgImage) {
                    const svgContainer = document.createElement('div');
                    svgContainer.className = 'print-question-svg';
                    svgContainer.innerHTML = question.svgImage;
                    const innerSvg = svgContainer.querySelector('svg');
                    if(innerSvg) {
                        innerSvg.setAttribute('width', '100%');
                        innerSvg.setAttribute('height', 'auto');
                    }
                    itemDiv.appendChild(svgContainer);
                }

                const optionsOl = document.createElement('ol');
                optionsOl.className = 'print-options';
                
                question.options.forEach((option, optionIndex) => {
                    const li = document.createElement('li');
                    li.className = 'print-option-item';
                    
                    const textSpan = document.createElement('span');
                    textSpan.textContent = `(${optionIndex + 1}) ${option.text}`;
                    li.appendChild(textSpan);

                    if (option.svgImage) {
                        const optionSvgContainer = document.createElement('div');
                        optionSvgContainer.className = 'print-option-svg';
                        optionSvgContainer.innerHTML = option.svgImage;
                        const innerOptionSvg = optionSvgContainer.querySelector('svg');
                        if(innerOptionSvg) {
                            innerOptionSvg.setAttribute('width', '100%');
                            innerOptionSvg.setAttribute('height', '100%');
                        }
                        li.appendChild(optionSvgContainer);
                    }
                    optionsOl.appendChild(li);
                });
                itemDiv.appendChild(optionsOl);
                questionsContainer.appendChild(itemDiv);
            });
            
            printableArea.appendChild(questionsContainer);
            window.print();
        }

        /** 9b. ì •ë‹µ/í•´ì„¤ë§Œ ì¸ì‡„í•˜ê¸° */
        function printAnswersOnly(quizData) {
            quizData = quizData || currentQuiz;
            printableArea.innerHTML = '';
            printableArea.classList.remove('aexport-print');

            const answersTitle = document.createElement('h1');
            answersTitle.innerHTML = (quizData.title ? `${quizData.title} ` : "") + 'ì •ë‹µ ë° í’€ì´'; 
            answersTitle.className = 'print-answer-key-title';
            printableArea.appendChild(answersTitle);

            const quickKeyTitle = document.createElement('h2');
            quickKeyTitle.innerHTML = 'ë¹ ë¥¸ ì •ë‹µ';
            quickKeyTitle.className = 'print-quick-key-title';
            printableArea.appendChild(quickKeyTitle);

            const quickKeyContainer = document.createElement('div');
            quickKeyContainer.className = 'print-quick-key-container';
            
            quizData.questions.forEach((question, index) => { 
                const keyItem = document.createElement('span');
                keyItem.className = 'print-quick-key-item';
                keyItem.textContent = `${index + 1}. (${question.answerIndex + 1})`;
                quickKeyContainer.appendChild(keyItem);
            });
            printableArea.appendChild(quickKeyContainer);

            const detailedTitle = document.createElement('h2');
            detailedTitle.innerHTML = 'ìƒì„¸ í’€ì´';
            detailedTitle.className = 'print-detailed-explanation-title';
            printableArea.appendChild(detailedTitle);

            const explanationsContainer = document.createElement('div');
            explanationsContainer.className = 'print-column-container';

            quizData.questions.forEach((question, index) => { 
                const answerItemDiv = document.createElement('div');
                answerItemDiv.className = 'print-answer-item';

                const qNum = document.createElement('h3');
                qNum.style.fontWeight = 'bold';
                qNum.textContent = `[${index + 1}ë²ˆ ë¬¸ì œ]`;
                answerItemDiv.appendChild(qNum);
                
                const answer = document.createElement('p');
                answer.className = 'print-answer';
                const correctOptionText = question.options[question.answerIndex].text;
                answer.textContent = `ì •ë‹µ: (${question.answerIndex + 1}) ${correctOptionText}`;
                answerItemDiv.appendChild(answer);
                
                if (question.explanation) {
                    const explanation = document.createElement('p');
                    explanation.className = 'print-explanation';
                    explanation.textContent = `í’€ì´: ${question.explanation}`;
                    answerItemDiv.appendChild(explanation);
                }
                
                explanationsContainer.appendChild(answerItemDiv);
            });
            
            printableArea.appendChild(explanationsContainer);
            window.print();
        }

        /** 10. JSON í…ìŠ¤íŠ¸ ë³µì‚¬ */
        function copyJsonToClipboard() {
            jsonInput.select();
            try {
                document.execCommand('copy');
                copyJsonBtn.textContent = 'ë³µì‚¬ ì™„ë£Œ!';
                copyJsonBtn.classList.add('bg-green-200');
                setTimeout(() => {
                    copyJsonBtn.textContent = 'ì˜ˆì œ ë³µì‚¬';
                    copyJsonBtn.classList.remove('bg-green-200');
                }, 2000);
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        /** 11. JSON ìˆ˜ì •í•˜ê¸° */
        function backToJsonEditor() {
            showSection('json-input-section');
            wrongAnswersList.innerHTML = '';
            wrongAnswersSection.classList.add('hidden');
        }

        /** 12. JSON ì…ë ¥ì°½ ë¹„ìš°ê¸° */
        function clearJsonInput() {
            jsonInput.value = '';
            jsonError.classList.add('hidden');
        }

        /** 13. URL íŒŒë¼ë¯¸í„°/í•´ì‹œ DBì— ì €ì¥ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸ (ìˆ˜ì •: B64 ì¦‰ì‹œ ë””ì½”ë”©) */
        async function handleUrlParametersAndRedirect() {
            try {
                const params = new URLSearchParams(window.location.search);
                const hash = window.location.hash;
                const mode = params.get('mode');
                
                // (ìˆ˜ì •) í•´ì‹œ(#q=)ì—ì„œ B64 ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ *ì¦‰ì‹œ ë””ì½”ë”©*
                const quizDataB64 = (hash && hash.startsWith('#q=')) ? hash.substring(3) : null;
                const jsonData = decodeBase64(quizDataB64); // B64 -> JSON ë¬¸ìì—´
                
                const name = params.get('name') || null;
                const msg = params.get('msg') || null;
                
                // (ìˆ˜ì •) DBì—ëŠ” B64ê°€ ì•„ë‹Œ *JSON ë¬¸ìì—´*ì„ ì €ì¥
                const state = { mode, data: jsonData, name, msg };
                await saveStateToDB(DB_STATE_KEY, state);
                
                window.location.href = window.location.pathname; // ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ ì—†ëŠ” / ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                
            } catch (error) {
                console.error("URL ì²˜ë¦¬ ë° DB ì €ì¥ ì‹¤íŒ¨:", error);
                jsonError.textContent = "URLì„ ì²˜ë¦¬í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                showSection('json-input-section');
            }
        }

        /** 14. ê³µìœ  ë§í¬ ìƒì„± (Qexportìš©) */
        function generateShareLink(jsonData, name, msg) {
            try {
                const utf8Bytes = new TextEncoder().encode(jsonData);
                const binaryString = String.fromCodePoint(...utf8Bytes);
                const base64Data = btoa(binaryString).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
                
                const params = new URLSearchParams();
                params.set('mode', 'Import');
                if (name) params.set('name', btoa(encodeURIComponent(name)));
                if (msg) params.set('msg', btoa(encodeURIComponent(msg)));
                
                const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}#q=${base64Data}`;
                return shareUrl;

            } catch (error) {
                console.error("ê³µìœ  ë§í¬ ìƒì„± ì‹¤íŒ¨:", error);
                alert("ë§í¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                return null;
            }
        }
        
        /** 15. Base64 ë°ì´í„° ë””ì½”ë“œ (ìˆ˜ì •: null ì²´í¬) */
        function decodeBase64(base64String) {
            if (!base64String) return null;
            const standardBase64 = base64String.replace(/-/g, '+').replace(/_/g, '/');
            const binaryString = atob(standardBase64);
            const utf8Bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                utf8Bytes[i] = binaryString.charCodeAt(i);
            }
            return new TextDecoder().decode(utf8Bytes);
        }

        // íŒì—… ê´€ë ¨ í•¨ìˆ˜/ë¦¬ìŠ¤ë„ˆ ì œê±°

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        window.addEventListener('DOMContentLoaded', async () => {
            
            // --- ê³µí†µ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ---
            loadJsonBtn.addEventListener('click', () => loadJsonData());
            resetDefaultJsonBtn.addEventListener('click', () => {
                jsonInput.value = DEFAULT_QUIZ_JSON;
                jsonError.classList.add('hidden');
            });
            copyJsonBtn.addEventListener('click', copyJsonToClipboard);
            clearJsonBtn.addEventListener('click', clearJsonInput);
            
            startQuizBtn.addEventListener('click', startQuiz); // (ìˆ˜ì •) íŒì—… ì—†ìŒ
            printQuestionsBtn.addEventListener('click', printQuestionsOnly);
            printAnswersBtn.addEventListener('click', () => printAnswersOnly(currentQuiz));
            
            backToJsonBtn.addEventListener('click', backToJsonEditor);
            quitQuizBtn.addEventListener('click', resetApp);
            nextQuestionBtn.addEventListener('click', goToNextQuestion);
            restartQuizBtn.addEventListener('click', resetApp);

            // --- Export ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ (DB ì €ì¥ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸) ---
            qexportBtn.addEventListener('click', async () => {
                try {
                    const state = { mode: 'Qex', data: JSON.stringify(currentQuiz) };
                    await saveStateToDB(DB_STATE_KEY, state);
                    window.location.href = window.location.pathname; // ë¦¬ë‹¤ì´ë ‰íŠ¸
                } catch (e) { console.error("Qexport DB ì €ì¥ ì‹¤íŒ¨:", e); }
            });
            aexportBtn.addEventListener('click', async () => {
                try {
                    const state = { mode: 'Aex', data: JSON.stringify(currentQuiz) };
                    await saveStateToDB(DB_STATE_KEY, state);
                    window.location.href = window.location.pathname; // ë¦¬ë‹¤ì´ë ‰íŠ¸
                } catch (e) { console.error("Aexport DB ì €ì¥ ì‹¤íŒ¨:", e); }
            });
            
            // Qexport ì„¹ì…˜ ë²„íŠ¼
            qexportGenerateBtn.addEventListener('click', () => {
                const name = qexportName.value || "ì¹œêµ¬ê°€";
                const msg = qexportMsg.value || "ì´ ë¬¸ì œ í•œë²ˆ í’€ì–´ë´!";
                const url = generateShareLink(JSON.stringify(currentQuiz), name, msg);
                if (url) {
                    qexportResultUrl.value = url;
                    qexportResultContainer.classList.remove('hidden');
                }
            });
            qexportResultUrl.addEventListener('click', () => {
                qexportResultUrl.select();
                document.execCommand('copy');
                alert("ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
            });
            qexportBackBtn.addEventListener('click', () => {
                jsonInput.value = JSON.stringify(currentQuiz);
                loadJsonData(); // í€´ì¦ˆ ë¡œë“œ
            });

            // Aexport ì„¹ì…˜ ë²„íŠ¼
            aexportPrintBtn.addEventListener('click', () => {
                 printableArea.innerHTML = aexportContent.innerHTML;
                 printableArea.classList.add('aexport-print');
                 window.print();
                 printableArea.classList.remove('aexport-print');
            });
            aexportBackBtn.addEventListener('click', () => {
                jsonInput.value = JSON.stringify(currentQuiz);
                loadJsonData(); // í€´ì¦ˆ ë¡œë“œ
            });


            // --- (ì‹ ê·œ) í˜ì´ì§€ ë¡œë“œ ë¼ìš°íŒ… ---
            try {
                await initDB();
                const params = new URLSearchParams(window.location.search);
                const hash = window.location.hash;

                if (params.has('mode')) {
                    // 1. [ì§„ì…] ?mode=... íŒŒë¼ë¯¸í„°ê°€ ìˆìŒ -> DB ì €ì¥ ë° / ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    await handleUrlParametersAndRedirect();
                    return; // ë¦¬ë‹¤ì´ë ‰íŠ¸ê°€ ì‹¤í–‰ë  ê²ƒì´ë¯€ë¡œ ì¤‘ë‹¨
                
                } else {
                    // 2. [ë¡œë“œ] / ë¡œ ì ‘ì† (DB í™•ì¸)
                    const state = await loadStateFromDB(DB_STATE_KEY);
                    await deleteStateFromDB(DB_STATE_KEY); // (ìˆ˜ì •) ì½ì€ í›„ ì¦‰ì‹œ ì‚­ì œ
                    
                    const { mode, data, name, msg } = state;
                    
                    // (ìˆ˜ì •) dataëŠ” ì´ì œ í•­ìƒ JSON ë¬¸ìì—´ (Import/Qex/Aex ëª¨ë‘)
                    const quizData = data; 
                    
                    if (!quizData) {
                        throw new Error("DB state contained no quiz data.");
                    }

                    currentQuiz = JSON.parse(quizData);
                    jsonInput.value = quizData; 

                    switch (mode) {
                        case 'Import':
                            importName.textContent = name ? decodeURIComponent(atob(name)) : "ì¹œêµ¬ê°€";
                            importMsg.textContent = msg ? decodeURIComponent(atob(msg)) : "í€´ì¦ˆë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.";
                            
                            importStartBtn.onclick = async () => {
                                try {
                                    // (ìˆ˜ì •) Importì—ì„œ Qexë¡œ ê°ˆ ë•, currentQuizê°€ í•„ìš”í•¨
                                    currentQuiz = JSON.parse(quizData); 
                                    const state = { mode: 'Quiz', data: JSON.stringify(currentQuiz) };
                                    await saveStateToDB(DB_STATE_KEY, state);
                                    window.location.href = window.location.pathname;
                                } catch (e) { console.error("Import Start DB ì €ì¥ ì‹¤íŒ¨:", e); }
                            };
                            importPrintBtn.onclick = async () => {
                                try {
                                    currentQuiz = JSON.parse(quizData); 
                                    const state = { mode: 'Print', data: JSON.stringify(currentQuiz) };
                                    await saveStateToDB(DB_STATE_KEY, state);
                                    window.location.href = window.location.pathname;
                                } catch (e) { console.error("Import Print DB ì €ì¥ ì‹¤íŒ¨:", e); }
                            };
                            importShareBtn.onclick = async () => {
                                try {
                                    currentQuiz = JSON.parse(quizData); 
                                    const state = { mode: 'Qex', data: JSON.stringify(currentQuiz) };
                                    await saveStateToDB(DB_STATE_KEY, state);
                                    window.location.href = window.location.pathname;
                                } catch (e) { console.error("Import Share DB ì €ì¥ ì‹¤íŒ¨:", e); }
                            };
                            showSection('import-section');
                            break;
                        
                        case 'Qex':
                            showSection('qexport-section');
                            break;
                            
                        case 'Aex':
                            renderAnswersOnly(currentQuiz);
                            showSection('aexport-section');
                            break;
                            
                        case 'Print':
                            loadJsonData('Print'); // Print ëª¨ë“œë¡œ UI ë¡œë“œ
                            break;
                            
                        case 'Quiz':
                            loadJsonData('Quiz'); // Quiz ëª¨ë“œë¡œ UI ë¡œë“œ
                            // (ìˆ˜ì •) ìë™ ì‹œì‘ì´ ì•„ë‹ˆë¼ 'í€´ì¦ˆ í’€ê¸°' ë²„íŠ¼ì„ ë³´ì—¬ì¤Œ
                            // startQuiz(); 
                            break;

                        default:
                             throw new Error("Unknown mode in DB.");
                    }
                }
                
            } catch (error) {
                // 3. [ê¸°ë³¸] DBì— ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš° -> í¸ì§‘ê¸° ëª¨ë“œ
                console.log("DB ë°ì´í„° ì—†ìŒ, í¸ì§‘ê¸° ëª¨ë“œë¡œ ì‹œì‘:", error.message);
                jsonInput.value = DEFAULT_QUIZ_JSON;
                showSection('json-input-section');
            }
        });

    </script>
</body>
</html>
