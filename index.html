<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON í€´ì¦ˆ ìƒì„±ê¸° (í’€ê¸° ë° ì¸ì‡„)</title>
    <!-- Tailwind CSS ë¡œë“œ --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ë³¸ ê¸€ê¼´ ì„¤ì • */
        body {
            font-family: 'Inter', 'Pretendard', sans-serif;
        }

        /* * ======================================
         * ì¸ì‡„ ì „ìš© ìŠ¤íƒ€ì¼ (A4 ìš©ì§€)
         * (ìˆ˜ì •) 10pt í°íŠ¸, 2ì—´(column) ë ˆì´ì•„ì›ƒ ì ìš©
         * ======================================
         */
        @media print {
            /* * 1. ì•±ì˜ UI(ë²„íŠ¼, ì…ë ¥ì°½ ë“±)ëŠ” ëª¨ë‘ ìˆ¨ê¹ë‹ˆë‹¤.
             */
            body > #app-container {
                display: none;
            }

            /* * 2. ì¸ì‡„ ì „ìš© ì˜ì—­(#printable-area)ë§Œ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
             */
            body > #printable-area {
                display: block !important; /* ê°•ì œë¡œ ë³´ì´ê²Œ í•¨ */
            }

            /* * 3. A4 ìš©ì§€ ì—¬ë°± ì„¤ì •
             */
            @page {
                size: A4;
                margin: 1.2cm;
            }

            /* * 4. ì¸ì‡„ìš© í°íŠ¸ ë° í˜ì´ì§€ ë‚˜ëˆ” ì„¤ì •
             */
            #printable-area {
                font-size: 10pt; /* (ìˆ˜ì •) 10pt í°íŠ¸ë¡œ ì„¤ì • */
                color: #000;
            }
            
            /* (ì‹ ê·œ) 2ì—´ ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ */
            .print-column-container {
                column-count: 2;
                column-gap: 1.5cm; /* 1.5cm ê°„ê²© */
            }

            .print-question-item {
                margin-bottom: 10px;
                page-break-inside: avoid; /* ì—´(column)ì´ë‚˜ í˜ì´ì§€ ì¤‘ê°„ì— ì˜ë¦¬ëŠ” ê²ƒì„ ë°©ì§€ */
            }

            .print-question-title {
                font-size: 1.1em;
                font-weight: bold;
                margin-bottom: 5px;
            }
            
            .print-question-svg {
                margin: 6px 0;
                max-width: 240px;
                margin-left: auto;
                margin-right: auto;
            }
            .print-question-svg svg {
                max-width: 100%;
                height: auto;
                border: 1px solid #ccc;
            }

            .print-options {
                list-style-type: none; /* JSì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‚½ì… */
                list-style-position: inside;
                padding-left: 5px;
            }

            .print-option-item {
                display: flex;
                align-items: center;
                margin-bottom: 3px;
            }
            .print-option-svg {
                width: 26px;
                height: 26px;
                margin-left: 8px;
                border: 1px solid #ddd;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }
            .print-option-svg svg {
                width: 100%;
                height: 100%;
            }

            .print-answer {
                font-weight: bold;
                color: #333;
                margin-top: 5px;
            }
            
            .print-explanation {
                font-size: 0.95em;
                color: #444;
                margin-top: 4px;
                border-left: 2px solid #ddd;
                padding-left: 8px;
            }
            
            .print-quiz-title { /* (ì‹ ê·œ) í€´ì¦ˆ ì œëª© */
                text-align: center;
                font-size: 1.6em;
                font-weight: bold;
                margin-bottom: 0.8cm;
                margin-top: 0.2cm;
            }

            .print-answer-key-title {
                text-align: center;
                font-size: 1.4em;
                font-weight: bold;
                margin-top: 0.5cm;
                margin-bottom: 12px;
            }
            
            .print-quick-key-title {
                font-size: 1.2em;
                font-weight: bold;
                margin-top: 12px;
                margin-bottom: 8px;
                border-bottom: 1px solid #666;
                padding-bottom: 4px;
            }
            .print-quick-key-container {
                margin-bottom: 15px;
                page-break-inside: avoid;
                font-size: 10pt;
            }
            .print-quick-key-item {
                display: inline-block;
                margin: 0 10px 4px 0;
                font-weight: bold;
                min-width: 55px;
            }

            .print-detailed-explanation-title {
                font-size: 1.2em;
                font-weight: bold;
                margin-top: 20px;
                margin-bottom: 8px;
                border-bottom: 1px solid #666;
                padding-bottom: 4px;
            }

            .print-answer-item {
                margin-bottom: 8px;
                page-break-inside: avoid; /* ì—´(column)ì´ë‚˜ í˜ì´ì§€ ì¤‘ê°„ì— ì˜ë¦¬ëŠ” ê²ƒì„ ë°©ì§€ */
            }
        }

        /* * ======================================
         * ì•± UI ìŠ¤íƒ€ì¼ (Tailwind ëŒ€ì²´)
         * ======================================
         */

        /* (ìˆ˜ì •) í€´ì¦ˆ ë ˆì´ì•„ì›ƒ */
        #quiz-content-area {
            display: flex;
            flex-direction: column; /* ëª¨ë°”ì¼ ê¸°ë³¸: ìˆ˜ì§ ì •ë ¬ */
            gap: 24px; /* gap-6 */
            min-height: 400px; /* ìµœì†Œ ë†’ì´ ì„¤ì • */
        }
        
        #quiz-question-area { /* ì™¼ìª½: ë¬¸ì œ, SVG */
            flex: 1 1 50%; 
            padding-right: 0; /* md ì´ìƒì—ì„œë§Œ ì ìš© */
            border-right: none; /* md ì´ìƒì—ì„œë§Œ ì ìš© */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        #quiz-options-area { /* ì˜¤ë¥¸ìª½: ë³´ê¸° */
            flex: 1 1 50%; 
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 12px; /* space-y-3 */
        }
        
        /* (ì‹ ê·œ) ë°ìŠ¤í¬íƒ‘ 2ë¶„í•  ë ˆì´ì•„ì›ƒ */
        @media (min-width: 768px) { /* md: */
             #quiz-content-area {
                flex-direction: row; /* ë°ìŠ¤í¬íƒ‘: ìˆ˜í‰ ì •ë ¬ */
             }
             #quiz-question-area {
                padding-right: 16px; /* pr-4 */
                border-right: 1px solid #e5e7eb; /* border-r border-gray-200 */
             }
        }


        /* (ì‹ ê·œ) íƒ€ì´ë¨¸ ë°” ìŠ¤íƒ€ì¼ */
        #timer-bar-container {
            width: 100%;
            background-color: #e0e7ff; /* bg-indigo-100 */
            border-radius: 4px; /* rounded */
            height: 8px; /* h-2 */
            margin-top: 16px; /* mt-4 */
            overflow: hidden;
        }
        #timer-bar {
            height: 100%;
            background-color: #6366f1; /* bg-indigo-500 */
            width: 100%;
            transition: width 1s linear; /* ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ (1ì´ˆë§ˆë‹¤) */
        }
        
        /* (ì‹ ê·œ) HTML ë³´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .html-option {
            display: flex;
            align-items: stretch; /* ë†’ì´ë¥¼ ê½‰ ì±„ìš°ë„ë¡ */
            width: 100%;
            min-height: 56px; /* h-14 */
            padding: 0;
            border: 1.5px solid #d1d5db; /* border border-gray-300 */
            background-color: #f3f4f6; /* bg-gray-100 */
            border-radius: 8px; /* rounded-lg */
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            overflow: hidden; /* ë‚´ë¶€ ìš”ì†Œê°€ ë‘¥ê·¼ ëª¨ì„œë¦¬ë¥¼ ë„˜ì§€ ì•Šë„ë¡ */
        }
        
        .html-option:hover {
            background-color: #e5e7eb; /* hover:bg-gray-200 */
        }
        
        .option-content {
            flex-grow: 1;
            padding: 12px 16px; /* p-3 md:p-4 */
            font-size: 16px; /* text-base */
            color: #111827; /* text-gray-900 */
            line-height: 1.5;
        }
        
        .option-svg-wrapper {
            flex-shrink: 0;
            width: 56px; /* w-14 */
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1.5px solid #d1d5db; /* border-l border-gray-300 */
            background-color: #e5e7eb; /* bg-gray-200 */
            padding: 8px;
        }
        
        .option-svg-wrapper svg {
            width: 100%;
            height: 100%;
        }

        /* ë³´ê¸° ë²„íŠ¼ ìƒíƒœ: ì •ë‹µ */
        .html-option[data-state="correct"] {
            background-color: #dcfce7; /* bg-green-100 */
            border-color: #22c55e; /* border-green-500 */
            color: #166534; /* text-green-800 */
        }
        /* ë³´ê¸° ë²„íŠ¼ ìƒíƒœ: ì˜¤ë‹µ */
        .html-option[data-state="wrong"] {
            background-color: #fee2e2; /* bg-red-100 */
            border-color: #ef4444; /* border-red-500 */
            color: #991b1b; /* text-red-800 */
        }
        /* ë³´ê¸° ë²„íŠ¼ ìƒíƒœ: ë¹„í™œì„±í™” */
        .html-option[disabled] {
            cursor: default;
            opacity: 0.8;
        }
        .html-option[disabled]:hover {
            background-color: #f3f4f6; /* ë¹„í™œì„±í™” ì‹œ í˜¸ë²„ ìƒ‰ìƒ ì›ë³µ */
        }
        .html-option[data-state="correct"][disabled]:hover {
            background-color: #dcfce7;
        }
        .html-option[data-state="wrong"][disabled]:hover {
            background-color: #fee2e2;
        }
        
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-10">

    <!-- 
      ======================================
      ì•± ë©”ì¸ ì»¨í…Œì´ë„ˆ
      (ìˆ˜ì •) max-w-4xl -> max-w-5xl
      ======================================
    --><div id="app-container" class="max-w-5xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <!-- 1. JSON ì…ë ¥ ì„¹ì…˜ --><div id="json-input-section" class="p-6 md:p-8">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">JSON í€´ì¦ˆ ìƒì„±ê¸°</h1>
            <p class="text-gray-600 mb-5">
                ì•„ë˜ í…ìŠ¤íŠ¸ ì˜ì—­ì— í€´ì¦ˆ ë¬¸ì œë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
                <br>
                ì˜ˆì œ JSONì„ ì°¸ê³ í•˜ì—¬ í˜•ì‹ì„ ë§ì¶”ê±°ë‚˜, ì§ì ‘ ìˆ˜ì •í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>

            <!-- JSON ì…ë ¥ì°½ --><textarea id="json-input" rows="15" class="w-full p-4 border border-gray-300 rounded-lg font-mono text-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
            
            <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ --><p id="json-error" class="text-red-600 font-semibold mt-2 hidden"></p>

            <div class="flex flex-col gap-3 mt-4">
                <button id="load-json-btn" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-200">
                    ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
                <div class="grid grid-cols-3 gap-3">
                    <button id="reset-default-json-btn" class="w-full bg-gray-200 text-gray-700 px-5 py-3 rounded-lg hover:bg-gray-300 transition duration-200">
                        ì˜ˆì œ ì´ˆê¸°í™”
                    </button>
                    <button id="copy-json-btn" class="w-full bg-gray-200 text-gray-700 px-5 py-3 rounded-lg hover:bg-gray-300 transition duration-200">
                        ì˜ˆì œ ë³µì‚¬
                    </button>
                    <button id="clear-json-btn" class="w-full bg-red-500 text-white px-5 py-3 rounded-lg hover:bg-red-600 transition duration-200">
                        ì‚­ì œ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 2. ì•¡ì…˜ ì»¨íŠ¸ë¡¤ ì„¹ì…˜ (JSON ë¡œë“œ í›„ ë³´ì„) --><div id="action-controls" class="p-6 md:p-8 border-t border-gray-200 hidden">
            <h2 id="quiz-title-display" class="text-2xl font-bold text-gray-800 mb-4 text-center"></h2> <!-- (ì‹ ê·œ) í€´ì¦ˆ ì œëª© í‘œì‹œ --><div id="load-status" class="hidden mb-4 p-4 bg-green-100 text-green-800 rounded-lg">
                <span id="question-count" class="font-bold">0</span>ê°œì˜ ë¬¸ì œë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.
                <span id="timer-setting-display" class="block text-sm text-green-700 mt-1 hidden"></span> <!-- (ìˆ˜ì •) íƒ€ì´ë¨¸ ì„¤ì • í‘œì‹œ --></div>
            <div class="grid grid-cols-1 gap-4">
                <button id="start-quiz-btn" class="w-full bg-green-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-green-700 transition">
                    2. í€´ì¦ˆ í’€ê¸° ì‹œì‘!
                </button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="print-questions-btn" class="w-full bg-gray-700 text-white p-4 rounded-lg font-bold text-lg hover:bg-gray-800 transition">
                        ë¬¸ì œì§€ë§Œ ì¸ì‡„í•˜ê¸°
                    </button>
                    <button id="print-answers-btn" class="w-full bg-gray-800 text-white p-4 rounded-lg font-bold text-lg hover:bg-gray-900 transition">
                        ì •ë‹µ/í•´ì„¤ë§Œ ì¸ì‡„í•˜ê¸°
                    </button>
                </div>
            </div>
            
             <!-- (ìˆ˜ì •) JSON ìˆ˜ì •í•˜ê¸° / ê³µìœ í•˜ê¸° ë²„íŠ¼ ê·¸ë£¹ --><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <button id="back-to-json-btn" class="w-full bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 transition">
                    JSON ìˆ˜ì •í•˜ê¸°
                </button>
                <button id="share-link-btn" class="w-full bg-blue-100 text-blue-700 p-3 rounded-lg hover:bg-blue-200 transition">
                    ê³µìœ  ë§í¬ ìƒì„±
                </button>
             </div>
        </div>
        
        <!-- (ì‹ ê·œ) 3. íŒì—… ëŒ€ê¸° ì„¹ì…˜ (íŒì—… ë„ìš´ í›„ ë³´ì„) --><div id="popup-waiting-section" class="p-6 md:p-10 text-center hidden">
            <h2 id="popup-waiting-title" class="text-2xl font-bold text-gray-800 mb-4">í€´ì¦ˆ ì§„í–‰ ì¤‘...</h2>
            <p class="text-gray-600 mb-6">í€´ì¦ˆ íŒì—…ì°½ì—ì„œ ë¬¸ì œë¥¼ í’€ê³  ìˆìŠµë‹ˆë‹¤.</p>
            
            <div class="bg-blue-50 p-8 rounded-xl mb-6">
                <svg class="w-16 h-16 text-blue-600 mx-auto animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-lg text-blue-800 mt-4">íŒì—…ì°½ì´ ë‹«íˆë©´ ì´ê³³ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="reopen-popup-btn" class="w-full bg-gray-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-gray-700 transition">
                    íŒì—… ë‹¤ì‹œ ë„ìš°ê¸°
                </button>
                <button id="cancel-popup-btn" class="w-full bg-red-500 text-white p-4 rounded-lg font-bold text-lg hover:bg-red-600 transition">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>


        <!-- 3. í€´ì¦ˆ í’€ê¸° ì„¹ì…˜ (íŒì—…ì°½ ë‚´ë¶€ ë˜ëŠ” ë‹¨ë… ì‹¤í–‰ ì‹œ ë³´ì„) --><div id="quiz-section" class="p-6 md:p-8 hidden">
            <!-- í€´ì¦ˆ ìƒë‹¨ ë°” --><div class="flex justify-between items-center mb-6">
                <span id="quiz-run-title" class="text-lg font-bold text-gray-800 hidden"></span> <!-- (ì‹ ê·œ) í€´ì¦ˆ í’€ê¸° í™”ë©´ ì œëª© --><span id="progress-text" class="text-lg font-semibold text-gray-700">ë¬¸ì œ 1 / 10</span>
                <button id="quit-quiz-btn" class="text-sm text-red-600 hover:text-red-800 font-medium">
                    ì²˜ìŒìœ¼ë¡œ
                </button>
            </div>
            
            <!-- (ìˆ˜ì •) íƒ€ì´ë¨¸ í‘œì‹œ ì˜ì—­ --><div id="timer-container" class="flex justify-between items-center mb-4 hidden">
                <span id="time-left-text" class="text-lg font-bold text-indigo-700">--:--</span> <!-- (ìˆ˜ì •) 'ë‚¨ì€ ì‹œê°„:' í…ìŠ¤íŠ¸ ì‚­ì œ -->
                <div id="timer-bar-container">
                    <div id="timer-bar"></div>
                </div>
            </div>


            <!-- (ì‹ ê·œ) í€´ì¦ˆ ë‚´ìš© ì˜ì—­ - ì™¼ìª½ (ë¬¸ì œ, SVG) / ì˜¤ë¥¸ìª½ (ë³´ê¸°) --><div id="quiz-content-area" class="md:flex">
                <!-- ì™¼ìª½: ë¬¸ì œ ë° SVG ì°¸ê³ ìë£Œ --><div id="quiz-question-area" class="mb-6 md:mb-0">
                    <h2 id="question-title" class="text-2xl font-bold text-gray-900 mb-4"></h2>
                    <div id="question-svg-container" class="my-5 flex justify-center hidden">
                        <!-- JSê°€ ì´ê³³ì— SVGë¥¼ ì‚½ì… --></div>
                </div>
                
                <!-- ì˜¤ë¥¸ìª½: ë³´ê¸° ëª©ë¡ --><div id="quiz-options-area">
                    <!-- (ìˆ˜ì •) SVG <UL> ëŒ€ì‹  HTML ë²„íŠ¼ì„ ìœ„í•œ DIV ì‚¬ìš© -->
                    <!-- JSê°€ ì´ê³³ì— HTML ë³´ê¸° ë²„íŠ¼ì„ ì‚½ì… -->
                </div>
            </div>

            <!-- í”¼ë“œë°± ë° ë‹¤ìŒ ë²„íŠ¼ --><div class="mt-6 border-t border-gray-200 pt-6">
                <p id="feedback-text" class="text-xl font-bold"></p>
                <p id="explanation-text" class="mt-3 text-gray-700 bg-gray-100 p-4 rounded-md hidden"></p>
                <button id="next-question-btn" class="w-full bg-blue-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition mt-4 hidden">
                    ë‹¤ìŒ ë¬¸ì œë¡œ
                </button>
            </div>
        </div>

        <!-- 4. ìµœì¢… ê²°ê³¼ ì„¹ì…˜ (í€´ì¦ˆ ì¢…ë£Œ í›„ ë³´ì„) --><div id="results-section" class="p-6 md:p-10 text-center hidden">
            <h2 id="results-title" class="text-3xl font-bold text-gray-800 mb-4">í€´ì¦ˆ ì™„ë£Œ!</h2> <!-- (ìˆ˜ì •) í€´ì¦ˆ ê²°ê³¼ ì œëª© --><p class="text-xl text-gray-600 mb-6">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.</p>
            
            <div class="bg-blue-50 p-8 rounded-xl">
                <p class="text-lg text-blue-800">ì´ ë¬¸ì œ</p>
                <p id="total-questions-result" class="text-4xl font-extrabold text-blue-900 mb-4"></p>
                
                <p class="text-lg text-blue-800">ìµœì¢… ì ìˆ˜</p>
                <p id="final-score" class="text-6xl font-extrabold text-blue-900"></p>
            </div>

            <button id="restart-quiz-btn" class="w-full bg-blue-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition mt-8">
                ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>

            <!-- (ì‹ ê·œ) í‹€ë¦° ë¬¸ì œ í•´ì„¤ ì„¹ì…˜ -->
            <div id="wrong-answers-section" class="mt-10 text-left hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">í‹€ë¦° ë¬¸ì œ ë‹¤ì‹œ ë³´ê¸°</h3>
                <div id="wrong-answers-list" class="space-y-6">
                    <!-- JSê°€ ì´ê³³ì— í‹€ë¦° ë¬¸ì œ í•´ì„¤ì„ ì‚½ì… -->
                </div>
            </div>
        </div>

    </div>

    <!-- 
      ======================================
      ì¸ì‡„ ì „ìš© HTML ì˜ì—­ (í‰ì†Œì—ëŠ” ì•ˆ ë³´ì„)
      ======================================
    --><div id="printable-area" class="hidden">
        <!-- 
          JSê°€ ì´ê³³ì— ì¸ì‡„ìš© ì»¨í…ì¸ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
          (1ë¶€: ë¬¸ì œì§€, 2ë¶€: ì •ë‹µì§€)
        --></div>


    <!-- 
      ======================================
      ìë°”ìŠ¤í¬ë¦½íŠ¸ ë¡œì§
      ======================================
    --><script>
        // --- ì˜ˆì œ JSON ë°ì´í„° (ë¬¸ìì—´ í˜•íƒœ) ---
        // (ìˆ˜ì •) totalTimeLimitSeconds (ì´ ì‹œê°„)ìœ¼ë¡œ ë³€ê²½
        const DEFAULT_QUIZ_JSON = `
{
    "title": "ê¸°ë³¸ ìƒì‹ í€´ì¦ˆ",
    "totalTimeLimitSeconds": 60,
    "questions": [
        {
            "question": "ë‹¤ìŒ ì¤‘ HTML(HyperText Markup Language)ì˜ ì•½ìê°€ ì˜¬ë°”ë¥¸ ê²ƒì€?",
            "options": [
                { "text": "Hyperlinks and Text Markup Language" },
                { "text": "Home Tool Markup Language" },
                { "text": "HyperText Markup Language" },
                { "text": "Hyper Tool Multi Language" },
                { "text": "HighText Machine Language" }
            ],
            "answerIndex": 2,
            "explanation": "HTMLì€ 'HyperText Markup Language'ì˜ ì•½ìì…ë‹ˆë‹¤. ì›¹ í˜ì´ì§€ì˜ êµ¬ì¡°ë¥¼ ì •ì˜í•˜ëŠ” ë§ˆí¬ì—… ì–¸ì–´ì…ë‹ˆë‹¤."
        },
        {
            "question": "ë‹¤ìŒì€ í…ìŠ¤íŠ¸ê°€ ë§¤ìš° ê¸¸ì–´ì„œ ë‘ ì¤„ ì´ìƒìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” ì„ ì§€ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì´ í…ìŠ¤íŠ¸ëŠ” ìë™ìœ¼ë¡œ ì¤„ë°”ê¿ˆë˜ì–´ì•¼ í•˜ë©°, ë²„íŠ¼ì˜ ë†’ì´ë„ ê·¸ì— ë§ê²Œ ìë™ìœ¼ë¡œ ëŠ˜ì–´ë‚˜ì•¼ í•©ë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì´ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.",
            "options": [
                { "text": "ì§§ì€ í…ìŠ¤íŠ¸" },
                { "text": "JQuery" },
                { "text": "ì´ê²ƒì€ ë§¤ìš° ê¸´ í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì´ í…ìŠ¤íŠ¸ëŠ” ë²„íŠ¼ ë°–ìœ¼ë¡œ ë„˜ì¹˜ì§€ ì•Šê³  ìë™ìœ¼ë¡œ ì¤„ë°”ê¿ˆ(wrapping)ë˜ì–´ ì—¬ëŸ¬ ì¤„ì— ê±¸ì³ í‘œì‹œë˜ì–´ì•¼ í•©ë‹ˆë‹¤. HTML ìš”ì†ŒëŠ” ì´ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤." },
                { "text": "JavaScript" },
                { "text": "CSS (ì •ë‹µ)" }
            ],
            "answerIndex": 4,
            "explanation": "CSS(Cascading Style Sheets)ëŠ” ì›¹ í˜ì´ì§€ì˜ ë””ìì¸ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤."
        },
        {
            "question": "ë‹¤ìŒ ë³´ê¸° ì¤‘ 'ë‘¥ê·¼ ì‚¬ê°í˜•(Rounded Rectangle)'ì„ ë‚˜íƒ€ë‚´ëŠ” SVGëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
            "svgImage": "<svg viewBox='0 0 100 60' xmlns='http://www.w3.org/2000/svg' class='w-full max-w-xs border rounded-md'><rect x='10' y='10' width='80' height='40' rx='10' stroke='blue' stroke-width='3' fill='lightblue'/><text x='50' y='35' text-anchor='middle' font-size='10' fill='black'>ì§ˆë¬¸ SVG</text></svg>",
            "options": [
                { "text": "ì›", "svgImage": "<svg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'><circle cx='20' cy='20' r='18' stroke='black' stroke-width='2' fill='none'/></svg>" },
                { "text": "ì¼ë°˜ ì‚¬ê°í˜•", "svgImage": "<svg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'><rect x='5' y='5' width='30' height='30' stroke='black' stroke-width='2' fill='none'/></svg>" },
                { "text": "ì‚¼ê°í˜•", "svgImage": "<svg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'><polygon points='20,5 35,35 5,35' stroke='black' stroke-width='2' fill='none'/></svg>" },
                { "text": "ë‘¥ê·¼ ì‚¬ê°í˜•", "svgImage": "<svg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'><rect x='5' y='5' width='30' height='30' rx='8' stroke='black' stroke-width='2' fill='none'/></svg>" },
                { "text": "íƒ€ì›", "svgImage": "<svg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'><ellipse cx='20' cy='20' rx='18' ry='12' stroke='black' stroke-width='2' fill='none'/></svg>" }
            ],
            "answerIndex": 3,
            "explanation": "ì •ë‹µì€ 4ë²ˆì§¸ ë³´ê¸°ì…ë‹ˆë‹¤. <rect> íƒœê·¸ì˜ 'rx' ì†ì„±ì€ ëª¨ì„œë¦¬ì˜ ë‘¥ê·¼ ì •ë„ë¥¼ ì§€ì •í•©ë‹ˆë‹¤."
        },
        {
            "question": "ë‹¤ìŒ SVG ì½”ë“œì— ëŒ€í•œ ì„¤ëª…ìœ¼ë¡œ ì˜³ì€ ê²ƒì€?",
            "svgImage": "<svg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'><circle cx='50' cy='50' r='40' fill='red'/></svg>",
            "options": [
                { "text": "íŒŒë€ìƒ‰ ì‚¬ê°í˜•ì„ ê·¸ë¦°ë‹¤." },
                { "text": "ì¤‘ì‹¬ì´ (50,50)ì¸ ë°˜ì§€ë¦„ 40ì˜ ë¹¨ê°„ìƒ‰ ì›ì„ ê·¸ë¦°ë‹¤." },
                { "text": "íƒ€ì›ì„ ê·¸ë¦°ë‹¤." },
                { "text": "í…ìŠ¤íŠ¸ë¥¼ í‘œì‹œí•œë‹¤." },
                { "text": "ì„ ì„ ê·¸ë¦°ë‹¤." }
            ],
            "answerIndex": 1,
            "explanation": "<circle> íƒœê·¸ëŠ” ì›ì„, cx/cyëŠ” ì¤‘ì‹¬ ì¢Œí‘œ, rì€ ë°˜ì§€ë¦„, fillì€ ìƒ‰ìƒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤."
        }
    ]
}
`;

        // --- ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ---
        let db; // (ì‹ ê·œ) IndexedDB ì¸ìŠ¤í„´ìŠ¤
        const DB_NAME = 'QuizAppDB';
        const STORE_NAME = 'Quizzes';
        const QUIZ_ID_KEY = 'currentQuizData'; // (ì‹ ê·œ) DBì— ì €ì¥í•  í€´ì¦ˆì˜ í‚¤

        let currentQuiz = {}; 
        let currentQuestionIndex = 0;
        let score = 0;
        let isAnswered = false; 
        let timerInterval; 
        let timeLeft; 
        let wrongAnswers = []; 
        
        let quizPopup; // (ì‹ ê·œ) íŒì—…ì°½ ì°¸ì¡°
        let popupCheckInterval; // (ì‹ ê·œ) íŒì—… ë‹«í˜ ê°ì§€ ì¸í„°ë²Œ

        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const appContainer = document.getElementById('app-container'); // (ì‹ ê·œ) ì•± ì „ì²´ ì»¨í…Œì´ë„ˆ
        const jsonInputSection = document.getElementById('json-input-section'); 
        const jsonInput = document.getElementById('json-input');
        const jsonError = document.getElementById('json-error');
        const loadJsonBtn = document.getElementById('load-json-btn');
        const resetDefaultJsonBtn = document.getElementById('reset-default-json-btn');
        const copyJsonBtn = document.getElementById('copy-json-btn');
        const clearJsonBtn = document.getElementById('clear-json-btn'); 
        
        const actionControls = document.getElementById('action-controls');
        const quizTitleDisplay = document.getElementById('quiz-title-display'); 
        const loadStatus = document.getElementById('load-status');
        const questionCount = document.getElementById('question-count');
        const timerSettingDisplay = document.getElementById('timer-setting-display'); 
        
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const printQuestionsBtn = document.getElementById('print-questions-btn');
        const printAnswersBtn = document.getElementById('print-answers-btn');
        const backToJsonBtn = document.getElementById('back-to-json-btn');
        const shareLinkBtn = document.getElementById('share-link-btn'); 
        
        const popupWaitingSection = document.getElementById('popup-waiting-section'); // (ì‹ ê·œ) íŒì—… ëŒ€ê¸°
        const reopenPopupBtn = document.getElementById('reopen-popup-btn'); // (ì‹ ê·œ)
        const cancelPopupBtn = document.getElementById('cancel-popup-btn'); // (ì‹ ê·œ)

        const quizSection = document.getElementById('quiz-section');
        const quizRunTitle = document.getElementById('quiz-run-title'); 
        const quitQuizBtn = document.getElementById('quit-quiz-btn');
        const progressText = document.getElementById('progress-text');
        const timerContainer = document.getElementById('timer-container'); 
        const timeLeftText = document.getElementById('time-left-text'); 
        const timerBar = document.getElementById('timer-bar'); 
        const timerBarContainer = document.getElementById('timer-bar-container'); 
        
        const questionTitle = document.getElementById('question-title');
        const svgContainer = document.getElementById('question-svg-container');
        const optionsArea = document.getElementById('quiz-options-area'); // (ìˆ˜ì •) optionsList -> optionsArea
        
        const feedbackText = document.getElementById('feedback-text');
        const explanationText = document.getElementById('explanation-text');
        const nextQuestionBtn = document.getElementById('next-question-btn');

        const resultsSection = document.getElementById('results-section');
        const resultsTitle = document.getElementById('results-title'); 
        const totalQuestionsResult = document.getElementById('total-questions-result');
        const finalScore = document.getElementById('final-score');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        const wrongAnswersSection = document.getElementById('wrong-answers-section'); 
        const wrongAnswersList = document.getElementById('wrong-answers-list'); 

        const printableArea = document.getElementById('printable-area');

        // --- (ì‹ ê·œ) IndexedDB í—¬í¼ í•¨ìˆ˜ ---

        /** DB ì´ˆê¸°í™” */
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("IndexedDB initialized");
                    resolve(db);
                };
                
                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        /** DBì— í€´ì¦ˆ ì €ì¥ */
        function saveQuizToDB(id, data) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.error("DB not initialized.");
                    reject("DB not initialized");
                    return;
                }
                try {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.put({ id: id, data: data });
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        /** DBì—ì„œ í€´ì¦ˆ ë¡œë“œ */
        function loadQuizFromDB(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.error("DB not initialized.");
                    reject("DB not initialized");
                    return;
                }
                try {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(id);
                    
                    request.onsuccess = (event) => {
                        if (event.target.result) {
                            resolve(event.target.result.data);
                        } else {
                            reject("Quiz not found in DB");
                        }
                    };
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        /** DBì—ì„œ í€´ì¦ˆ ì‚­ì œ */
        function deleteQuizFromDB(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.log("DB not initialized, nothing to delete.");
                    resolve(); // DBê°€ ì—†ìœ¼ë©´ ì‚­ì œí•  ê²ƒë„ ì—†ìŒ
                    return;
                }
                try {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.delete(id);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }


        // --- í•¨ìˆ˜ ì •ì˜ ---

        /** 1. JSON ë¶ˆëŸ¬ì˜¤ê¸° ë° ìœ íš¨ì„± ê²€ì‚¬ */
        function loadJsonData() {
            try {
                const rawJson = jsonInput.value;
                const parsedData = JSON.parse(rawJson); 

                
                if (typeof parsedData !== 'object' || parsedData === null || !Array.isArray(parsedData.questions)) {
                    throw new Error("JSON ë°ì´í„°ëŠ” ìµœìƒìœ„ ê°ì²´ì—¬ì•¼ í•˜ë©°, 'questions' ë°°ì—´ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.");
                }

                if (parsedData.questions.length === 0) {
                    throw new Error("'questions' ë°°ì—´ì€ ë¹„ì–´ìˆì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.");
                }
                
                
                if (parsedData.title && typeof parsedData.title !== 'string') {
                    throw new Error("JSONì˜ 'title' ì†ì„±ì€ ë¬¸ìì—´(string)ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                }

                
                if (parsedData.totalTimeLimitSeconds && typeof parsedData.totalTimeLimitSeconds !== 'number') {
                    throw new Error("JSONì˜ 'totalTimeLimitSeconds' ì†ì„±ì€ ìˆ«ì(number)ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                }
                if (parsedData.totalTimeLimitSeconds && parsedData.totalTimeLimitSeconds <= 0) {
                    throw new Error("JSONì˜ 'totalTimeLimitSeconds'ì€ 0ë³´ë‹¤ í° ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.");
                }


                // ê° ë¬¸ì œì˜ í˜•ì‹ ê²€ì‚¬ (parsedData.questions ë°°ì—´ ìˆœíšŒ)
                for (const item of parsedData.questions) {
                    if (!item.question || !Array.isArray(item.options) || item.options.length === 0 || typeof item.answerIndex !== 'number') {
                        throw new Error("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ê° ë¬¸ì œëŠ” 'question', 'options' ë°°ì—´, 'answerIndex' ìˆ«ìê°€ í•„ìš”í•©ë‹ˆë‹¤.");
                    }
                    
                    for (const opt of item.options) {
                        if (typeof opt !== 'object' || opt === null || typeof opt.text !== 'string') {
                            throw new Error("ê° 'options' í•­ëª©ì€ 'text' ì†ì„±ì„ ê°€ì§„ ê°ì²´(object)ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                        }
                        if (opt.svgImage && typeof opt.svgImage !== 'string') {
                            throw new Error("optionsì˜ 'svgImage' ì†ì„±ì´ ì¡´ì¬í•œë‹¤ë©´, ë¬¸ìì—´(string)ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                        }
                    }
                    if (item.svgImage && typeof item.svgImage !== 'string') {
                        throw new Error("'svgImage' ì†ì„±ì´ ì¡´ì¬í•œë‹¤ë©´, ë¬¸ìì—´(string)ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                    }
                    if (item.explanation && typeof item.explanation !== 'string') {
                        throw new Error("'explanation' ì†ì„±ì´ ì¡´ì¬í•œë‹¤ë©´, ë¬¸ìì—´(string)ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                    }
                }

                // ì„±ê³µ
                currentQuiz = parsedData; 
                jsonError.classList.add('hidden');
                
                // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ í‘œì‹œ
                questionCount.textContent = currentQuiz.questions.length; 
                loadStatus.classList.remove('hidden'); 
                
                
                quizTitleDisplay.textContent = currentQuiz.title || "ì œëª© ì—†ëŠ” í€´ì¦ˆ";
                
                resultsTitle.textContent = currentQuiz.title ? `${currentQuiz.title} í€´ì¦ˆ ì™„ë£Œ!` : "í€´ì¦ˆ ì™„ë£Œ!";
                quizRunTitle.textContent = currentQuiz.title || "í€´ì¦ˆ í’€ê¸°";
                quizRunTitle.classList.remove('hidden');

                
                if (currentQuiz.totalTimeLimitSeconds) {
                    const minutes = Math.floor(currentQuiz.totalTimeLimitSeconds / 60);
                    const seconds = currentQuiz.totalTimeLimitSeconds % 60;
                    timerSettingDisplay.textContent = `(ì´ ì œí•œ ì‹œê°„: ${minutes}:${seconds.toString().padStart(2, '0')})`;
                    timerSettingDisplay.classList.remove('hidden');
                } else {
                    timerSettingDisplay.classList.add('hidden');
                }

                actionControls.classList.remove('hidden'); 
                
                
                if (window.opener) { // íŒì—…ì°½ì´ë©´ ìˆ˜ì •/ê³µìœ  ë²„íŠ¼ ìˆ¨ê¹€
                    backToJsonBtn.classList.add('hidden');
                    shareLinkBtn.classList.add('hidden');
                } else {
                    backToJsonBtn.classList.remove('hidden');
                    shareLinkBtn.classList.remove('hidden');
                }
                
                // ë‹¤ë¥¸ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                quizSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
                jsonInputSection.classList.add('hidden'); 

            } catch (error) {
                // ì‹¤íŒ¨
                currentQuiz = {}; 
                jsonError.textContent = `JSON ì˜¤ë¥˜: ${error.message}`;
                jsonError.classList.remove('hidden');
                actionControls.classList.add('hidden'); 
                jsonInputSection.classList.remove('hidden'); 
            }
        }

        /** íƒ€ì´ë¨¸ í‘œì‹œ í—¬í¼ í•¨ìˆ˜ (MM:SS í˜•ì‹) */
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            if (timeLeftText) {
                timeLeftText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }


        /** 2. í€´ì¦ˆ ì‹œì‘ (ìˆ˜ì •: ì „ì—­ íƒ€ì´ë¨¸ ì‹œì‘) */
        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            wrongAnswers = []; 
            
            actionControls.classList.add('hidden'); 
            resultsSection.classList.add('hidden');
            jsonInputSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
            
            // ì•± ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ë³€ê²½ (íŒì—…ì´ë¯€ë¡œ ìµœëŒ€ ë„ˆë¹„ ì œê±°)
            if (window.opener) {
                 appContainer.classList.remove('max-w-5xl', 'mx-auto', 'shadow-2xl', 'rounded-xl', 'overflow-hidden');
            }
            
            
            clearInterval(timerInterval); // ì´ì „ íƒ€ì´ë¨¸ ì´ˆê¸°í™”
            if (currentQuiz.totalTimeLimitSeconds) {
                timeLeft = currentQuiz.totalTimeLimitSeconds;
                timerContainer.classList.remove('hidden');
                updateTimerDisplay();
                
                if (timerBar) {
                    timerBar.style.transition = 'none'; // ì• ë‹ˆë©”ì´ì…˜ ì´ˆê¸°í™”
                    timerBar.style.width = '100%';
                    
                    
                    setTimeout(() => {
                        timerBar.style.transition = `width ${timeLeft}s linear`;
                        timerBar.style.width = '0%';
                    }, 100);
                }

                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        showResults(true); // ì‹œê°„ ì´ˆê³¼ë¡œ ê²°ê³¼ í‘œì‹œ
                    }
                }, 1000);
            } else {
                timerContainer.classList.add('hidden');
            }
            
            loadQuestion();
        }

        /** 3. ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸° (ìˆ˜ì •: HTML ë³´ê¸° ë²„íŠ¼) */
        function loadQuestion() {
            // ì´ˆê¸°í™”
            isAnswered = false;
            feedbackText.textContent = '';
            explanationText.textContent = '';
            explanationText.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            
            const currentQuestion = currentQuiz.questions[currentQuestionIndex]; 
            
            progressText.textContent = `ë¬¸ì œ ${currentQuestionIndex + 1} / ${currentQuiz.questions.length}`;
            questionTitle.textContent = currentQuestion.question;
            
            if (currentQuestion.svgImage) {
                svgContainer.innerHTML = currentQuestion.svgImage;
                svgContainer.classList.remove('hidden');
            } else {
                svgContainer.innerHTML = '';
                svgContainer.classList.add('hidden');
            }

            // (ìˆ˜ì •) ë³´ê¸° ë²„íŠ¼ì„ HTMLë¡œ ìƒì„±
            optionsArea.innerHTML = '';

            currentQuestion.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'html-option';
                
                // 1. í…ìŠ¤íŠ¸ ì»¨í…ì¸ 
                const contentDiv = document.createElement('div');
                contentDiv.className = 'option-content';
                contentDiv.textContent = `(${index + 1}) ${option.text}`;
                button.appendChild(contentDiv);

                // 2. SVG ì´ë¯¸ì§€ (ìˆì„ ê²½ìš°)
                if (option.svgImage) {
                    const svgWrapper = document.createElement('div');
                    svgWrapper.className = 'option-svg-wrapper';
                    svgWrapper.innerHTML = option.svgImage;
                    
                    const embeddedSvg = svgWrapper.querySelector('svg');
                    if (embeddedSvg) {
                        embeddedSvg.setAttribute('width', '100%');
                        embeddedSvg.setAttribute('height', '100%');
                    }
                    button.appendChild(svgWrapper);
                }
                
                button.addEventListener('click', () => selectAnswer(button, index));
                
                optionsArea.appendChild(button);
            });
        }

        /** 4. ë‹µì•ˆ ì„ íƒ (ìˆ˜ì •: HTML ë³´ê¸° ë²„íŠ¼ + íƒ€ì´ë¨¸ ì¼ì‹œ ì •ì§€) */
        function selectAnswer(selectedButton, selectedIndex) {
            if (isAnswered) return;
            
            
            clearInterval(timerInterval); 
            
            
            if(currentQuiz.totalTimeLimitSeconds && timerBar && timerBarContainer) {
                try {
                    const currentWidth = timerBar.getBoundingClientRect().width;
                    const containerWidth = timerBarContainer.getBoundingClientRect().width;
                    timerBar.style.transition = 'none';

                    
                    if (containerWidth > 0) {
                        timerBar.style.width = `${(currentWidth / containerWidth) * 100}%`;
                    } else if (timeLeft <= 0) {
                         timerBar.style.width = '0%'; // ì‹œê°„ì´ ë‹¤ ëœ ê²½ìš°
                    }
                } catch(e) {
                    console.warn("Timer bar pause failed:", e.message);
                }
            }

            isAnswered = true;
            const currentQuestion = currentQuiz.questions[currentQuestionIndex]; 
            const correctIndex = currentQuestion.answerIndex;

            const allOptionButtons = optionsArea.querySelectorAll('.html-option');
            
            if (selectedIndex === correctIndex) {
                // ì •ë‹µ
                score++;
                selectedButton.setAttribute('data-state', 'correct');
                feedbackText.textContent = 'ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!';
                feedbackText.style.color = 'green';
            } else {
                // ì˜¤ë‹µ
                wrongAnswers.push(currentQuestionIndex); 
                selectedButton.setAttribute('data-state', 'wrong');
                feedbackText.textContent = 'âŒ í‹€ë ¸ìŠµë‹ˆë‹¤.';
                feedbackText.style.color = 'red';
            }

            // ì •ë‹µ í‘œì‹œ
            const correctButton = allOptionButtons[correctIndex];
            if (correctButton) {
                correctButton.setAttribute('data-state', 'correct');
            }


            if (currentQuestion.explanation) {
                explanationText.textContent = `í’€ì´: ${currentQuestion.explanation}`;
                explanationText.classList.remove('hidden');
            }

            nextQuestionBtn.classList.remove('hidden');
            allOptionButtons.forEach(button => {
                button.disabled = true;
            });
        }

        /** 5. ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™ (ìˆ˜ì •: íƒ€ì´ë¨¸ ì¬ì‹œì‘) */
        function goToNextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuiz.questions.length) { 
                
                
                if (currentQuiz.totalTimeLimitSeconds && timeLeft > 0) {
                    updateTimerDisplay(); // í˜„ì¬ ë‚¨ì€ ì‹œê°„ìœ¼ë¡œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                    
                    if (timerBar) {
                        timerBar.style.transition = 'none'; // ì• ë‹ˆë©”ì´ì…˜ ì´ˆê¸°í™”
                        
                        setTimeout(() => {
                            timerBar.style.transition = `width ${timeLeft}s linear`;
                            timerBar.style.width = '0%';
                        }, 100);
                    }

                    timerInterval = setInterval(() => {
                        timeLeft--;
                        updateTimerDisplay();
                        
                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                            showResults(true); // ì‹œê°„ ì´ˆê³¼
                        }
                    }, 1000);
                }
                
                loadQuestion();
            } else {
                showResults(false); // ì‹œê°„ ì´ˆê³¼ ì•„ë‹˜
                
            }
        }

        /** 6. ê²°ê³¼ í™”ë©´ í‘œì‹œ (ìˆ˜ì •: íŒì—…ì°½ì—ì„œ postMessage) */
        function showResults(isTimeOut = false) {
            clearInterval(timerInterval); 
            
            // (ì‹ ê·œ) íŒì—…ì°½(window.opener)ì—ì„œ ì‹¤í–‰ëœ ê²½ìš°
            if (window.opener) {
                // 1. ë©”ì¸ì°½ìœ¼ë¡œ ê²°ê³¼ ë°ì´í„° ì „ì†¡
                window.opener.postMessage({
                    type: 'quizResult',
                    payload: {
                        score: score,
                        totalQuestions: currentQuiz.questions.length,
                        wrongAnswers: wrongAnswers,
                        quizData: currentQuiz, // í€´ì¦ˆ ì›ë³¸ ë°ì´í„°
                        isTimeOut: isTimeOut
                    }
                }, '*'); // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” '*' ëŒ€ì‹  ë©”ì¸ì°½ì˜ originì„ ì§€ì •í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
                
                // 2. íŒì—…ì°½ ë‹«ê¸°
                window.close();
                return; // íŒì—…ì°½ì—ì„œëŠ” ê²°ê³¼ í™”ë©´ì„ ë„ìš°ì§€ ì•ŠìŒ
            }

            // (ê¸°ì¡´) ë©”ì¸ì°½ì—ì„œ ë‹¨ë… ì‹¤í–‰ëœ ê²½ìš° (ì˜ˆ: íŒì—…ì´ ì°¨ë‹¨ëì„ ë•Œ)
            quizSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            
            const title = currentQuiz.title || "í€´ì¦ˆ";
            if (isTimeOut) {
                resultsTitle.textContent = "â° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤!";
            } else {
                resultsTitle.textContent = `${title} í€´ì¦ˆ ì™„ë£Œ!`;
            }
            
            totalQuestionsResult.textContent = `${currentQuiz.questions.length} ë¬¸ì œ`; 
            finalScore.textContent = `${score} ê°œ`;

            
            renderWrongAnswers(currentQuiz, wrongAnswers);
        }

        /** (ì‹ ê·œ) í‹€ë¦° ë¬¸ì œ í•´ì„¤ ë Œë”ë§ í•¨ìˆ˜ (ì¬ì‚¬ìš©) */
        function renderWrongAnswers(quizData, wrongIdxArray) {
            wrongAnswersList.innerHTML = ''; // ì´ˆê¸°í™”
            if (wrongIdxArray.length > 0) {
                wrongAnswersSection.classList.remove('hidden');
                
                wrongIdxArray.forEach(wrongIndex => {
                    const question = quizData.questions[wrongIndex];
                    if (!question) return; // ì•ˆì „ ì½”ë“œ
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'p-4 bg-gray-50 rounded-lg border border-gray-200';
                    
                    // 1. ë¬¸ì œ
                    const qTitle = document.createElement('h4');
                    qTitle.className = 'text-lg font-bold text-gray-800 mb-2';
                    qTitle.textContent = `[ë¬¸ì œ ${wrongIndex + 1}] ${question.question}`;
                    itemDiv.appendChild(qTitle);
                    
                    // 2. ì •ë‹µ
                    const answer = document.createElement('p');
                    answer.className = 'text-md font-semibold text-green-700';
                    const correctOptionText = question.options[question.answerIndex].text;
                    answer.textContent = `ì •ë‹µ: (${question.answerIndex + 1}) ${correctOptionText}`;
                    itemDiv.appendChild(answer);
                    
                    // 3. í•´ì„¤
                    if (question.explanation) {
                        const explanation = document.createElement('p');
                        explanation.className = 'text-md text-gray-700 mt-2 pt-2 border-t border-gray-200';
                        explanation.textContent = `í’€ì´: ${question.explanation}`;
                        itemDiv.appendChild(explanation);
                    }
                    
                    wrongAnswersList.appendChild(itemDiv);
                });

            } else {
                // í‹€ë¦° ë¬¸ì œê°€ ì—†ìœ¼ë©´
                wrongAnswersSection.classList.add('hidden');
                const noWrongMsg = document.createElement('p');
                noWrongMsg.className = "text-green-600 font-bold text-center text-lg";
                noWrongMsg.textContent = "ğŸ‰ ëª¨ë“  ë¬¸ì œë¥¼ ë§í˜”ìŠµë‹ˆë‹¤! ğŸ‰";
                wrongAnswersList.appendChild(noWrongMsg);
                wrongAnswersSection.classList.remove('hidden');
            }
        }


        /** 7. ì•± ì´ˆê¸°í™” (ì²˜ìŒìœ¼ë¡œ) (ìˆ˜ì •: DB ì‚­ì œ + íŒì—… ìƒíƒœ ì´ˆê¸°í™”) */
        async function resetApp() {
            // (ì‹ ê·œ) íŒì—… ê°ì§€ ì¸í„°ë²Œ ì¤‘ì§€
            clearInterval(popupCheckInterval);
            if (quizPopup && !quizPopup.closed) {
                quizPopup.close();
            }

            // (ì‹ ê·œ) DBì— ì €ì¥ëœ í€´ì¦ˆê°€ ìˆë‹¤ë©´ ì‚­ì œ
            try {
                await deleteQuizFromDB(QUIZ_ID_KEY);
                console.log("Quiz data cleared from DB.");
            } catch (error) {
                console.error("Failed to clear quiz data from DB:", error);
            }

            currentQuiz = {}; 
            currentQuestionIndex = 0;
            score = 0;
            clearInterval(timerInterval); 
            wrongAnswers = []; 
            
            quizSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            wrongAnswersSection.classList.add('hidden'); 
            wrongAnswersList.innerHTML = ''; 
            actionControls.classList.add('hidden');
            loadStatus.classList.add('hidden');
            popupWaitingSection.classList.add('hidden'); // (ì‹ ê·œ) íŒì—… ëŒ€ê¸°ì°½ ìˆ¨ê¸°ê¸°
            
            jsonInputSection.classList.remove('hidden'); 
            
            // (ìˆ˜ì •) URL í•´ì‹œ/ì¿¼ë¦¬ë§Œ ì œê±° (SecurityError ë°©ì§€)
            try {
                 window.history.pushState({}, '', window.location.pathname);
            } catch (e) {
                console.warn("Could not clear URL state:", e.message);
                // blob: í™˜ê²½ ë“±ì—ì„œ ì˜¤ë¥˜ ë°œìƒ ì‹œ, ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ëŒ€ì²´
                if (!window.opener) { // íŒì—…ì°½ì´ ì•„ë‹ ë•Œë§Œ
                     window.location.href = window.location.pathname;
                }
            }
           
            jsonInput.value = DEFAULT_QUIZ_JSON;
            jsonError.classList.add('hidden');
        }


        /** 9a. ë¬¸ì œì§€ë§Œ ì¸ì‡„í•˜ê¸° */
        function printQuestionsOnly() {
            printableArea.innerHTML = '';

            
            const quizTitle = document.createElement('h1');
            quizTitle.innerHTML = currentQuiz.title || "í€´ì¦ˆ ë¬¸ì œì§€";
            quizTitle.className = 'print-quiz-title';
            printableArea.appendChild(quizTitle);

            const questionsContainer = document.createElement('div');
            questionsContainer.className = 'print-column-container';

            currentQuiz.questions.forEach((question, index) => { 
                const itemDiv = document.createElement('div');
                itemDiv.className = 'print-question-item';

                // 1. ë¬¸ì œ
                const qTitle = document.createElement('h2');
                qTitle.className = 'print-question-title';
                qTitle.textContent = `${index + 1}. ${question.question}`;
                itemDiv.appendChild(qTitle);

                // 2. ë¬¸ì œ SVG
                if (question.svgImage) {
                    const svgContainer = document.createElement('div');
                    svgContainer.className = 'print-question-svg';
                    svgContainer.innerHTML = question.svgImage;
                    const innerSvg = svgContainer.querySelector('svg');
                    if(innerSvg) {
                        innerSvg.setAttribute('width', '100%');
                        innerSvg.setAttribute('height', 'auto');
                    }
                    itemDiv.appendChild(svgContainer);
                }

                // 3. ë³´ê¸°
                const optionsOl = document.createElement('ol');
                optionsOl.className = 'print-options';
                
                question.options.forEach((option, optionIndex) => {
                    const li = document.createElement('li');
                    li.className = 'print-option-item';
                    
                    const textSpan = document.createElement('span');
                    // í…ìŠ¤íŠ¸ì— (1), (2) ë²ˆí˜¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€
                    textSpan.textContent = `(${optionIndex + 1}) ${option.text}`;
                    li.appendChild(textSpan);

                    if (option.svgImage) {
                        const optionSvgContainer = document.createElement('div');
                        optionSvgContainer.className = 'print-option-svg';
                        optionSvgContainer.innerHTML = option.svgImage;
                        const innerOptionSvg = optionSvgContainer.querySelector('svg');
                        if(innerOptionSvg) {
                            innerOptionSvg.setAttribute('width', '100%');
                            innerOptionSvg.setAttribute('height', '100%');
                        }
                        li.appendChild(optionSvgContainer);
                    }
                    
                    optionsOl.appendChild(li);
                });
                itemDiv.appendChild(optionsOl);

                questionsContainer.appendChild(itemDiv);
            });
            
            printableArea.appendChild(questionsContainer);

            window.print();
        }

        /** 9b. ì •ë‹µ/í•´ì„¤ë§Œ ì¸ì‡„í•˜ê¸° (ë¹ ë¥¸ ì •ë‹µ + ìƒì„¸ í’€ì´) */
        function printAnswersOnly() {
            printableArea.innerHTML = '';

            // --- 0. ì „ì²´ ì œëª© ---
            const answersTitle = document.createElement('h1');
            answersTitle.innerHTML = (currentQuiz.title ? `${currentQuiz.title} ` : "") + 'ì •ë‹µ ë° í’€ì´'; 
            answersTitle.className = 'print-answer-key-title';
            printableArea.appendChild(answersTitle);

            // --- 1. ë¹ ë¥¸ ì •ë‹µ ---
            const quickKeyTitle = document.createElement('h2');
            quickKeyTitle.innerHTML = 'ë¹ ë¥¸ ì •ë‹µ';
            quickKeyTitle.className = 'print-quick-key-title';
            printableArea.appendChild(quickKeyTitle);

            const quickKeyContainer = document.createElement('div');
            quickKeyContainer.className = 'print-quick-key-container';
            
            currentQuiz.questions.forEach((question, index) => { 
                const keyItem = document.createElement('span');
                keyItem.className = 'print-quick-key-item';
                keyItem.textContent = `${index + 1}. (${question.answerIndex + 1})`; // ì˜ˆ: 1. (3)
                quickKeyContainer.appendChild(keyItem);
            });
            printableArea.appendChild(quickKeyContainer);

            // --- 2. ìƒì„¸ í’€ì´ ---
            const detailedTitle = document.createElement('h2');
            detailedTitle.innerHTML = 'ìƒì„¸ í’€ì´';
            detailedTitle.className = 'print-detailed-explanation-title';
            printableArea.appendChild(detailedTitle);

            // 2ì—´ ì»¨í…Œì´ë„ˆ ìƒì„±
            const explanationsContainer = document.createElement('div');
            explanationsContainer.className = 'print-column-container';

            currentQuiz.questions.forEach((question, index) => { 
                const answerItemDiv = document.createElement('div');
                answerItemDiv.className = 'print-answer-item';

                // ë¬¸ì œ ë²ˆí˜¸
                const qNum = document.createElement('h3');
                qNum.style.fontWeight = 'bold';
                qNum.textContent = `[${index + 1}ë²ˆ ë¬¸ì œ]`;
                answerItemDiv.appendChild(qNum);
                
                // ì •ë‹µ
                const answer = document.createElement('p');
                answer.className = 'print-answer';
                const correctOptionText = question.options[question.answerIndex].text;
                answer.textContent = `ì •ë‹µ: (${question.answerIndex + 1}) ${correctOptionText}`;
                answerItemDiv.appendChild(answer);
                
                // í’€ì´
                if (question.explanation) {
                    const explanation = document.createElement('p');
                    explanation.className = 'print-explanation';
                    explanation.textContent = `í’€ì´: ${question.explanation}`;
                    answerItemDiv.appendChild(explanation);
                }
                
                explanationsContainer.appendChild(answerItemDiv);
            });
            
            printableArea.appendChild(explanationsContainer);

            window.print();
        }

        /** 10. JSON í…ìŠ¤íŠ¸ ë³µì‚¬ */
        function copyJsonToClipboard() {
            jsonInput.select();
            
            try {
                document.execCommand('copy');
                copyJsonBtn.textContent = 'ë³µì‚¬ ì™„ë£Œ!';
                copyJsonBtn.classList.add('bg-green-200');
                
                setTimeout(() => {
                    copyJsonBtn.textContent = 'ì˜ˆì œ ë³µì‚¬';
                    copyJsonBtn.classList.remove('bg-green-200');
                }, 2000);
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        /** 11. JSON ìˆ˜ì •í•˜ê¸° (ì•¡ì…˜ ì»¨íŠ¸ë¡¤ -> JSON ì…ë ¥) */
        function backToJsonEditor() {
            actionControls.classList.add('hidden');
            loadStatus.classList.add('hidden');
            jsonInputSection.classList.remove('hidden'); 
            resultsSection.classList.add('hidden'); // (ì‹ ê·œ) ê²°ê³¼ì°½ ìˆ¨ê¸°ê¸°
            wrongAnswersSection.classList.add('hidden'); // (ì‹ ê·œ) í‹€ë¦° ë¬¸ì œ ìˆ¨ê¸°ê¸°
        }

        /** 12. JSON ì…ë ¥ì°½ ë¹„ìš°ê¸° */
        function clearJsonInput() {
            jsonInput.value = '';
            jsonError.classList.add('hidden');
        }

        /** 13. (ìˆ˜ì •) URL í•´ì‹œ ì²˜ë¦¬ -> DB ì €ì¥ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸ */
        async function handleHashRedirect(hash) {
            try {
                
                const quizDataB64 = hash.substring(3); // #q= ë¥¼ ì œê±°
                
                
                const standardBase64 = quizDataB64.replace(/-/g, '+').replace(/_/g, '/');
                const binaryString = atob(standardBase64);
                
                const utf8Bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    utf8Bytes[i] = binaryString.charCodeAt(i);
                }
                
                const decodedJson = new TextDecoder().decode(utf8Bytes);
                
                // (ì‹ ê·œ) DBì— ì €ì¥
                await saveQuizToDB(QUIZ_ID_KEY, decodedJson);
                
                // (ìˆ˜ì •) ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ ì—†ì´ ë¦¬ë‹¤ì´ë ‰íŠ¸
                window.location.href = window.location.pathname;
                
            } catch (error) {
                console.error("URL í•´ì‹œ ì²˜ë¦¬ ì‹¤íŒ¨:", error);
                jsonError.textContent = "URLì—ì„œ í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë§í¬ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”.";
                jsonError.classList.remove('hidden');
                jsonInputSection.classList.remove('hidden'); 
            }
        }

        /** 14. ê³µìœ  ë§í¬ ìƒì„± (í•´ì‹œ ì‚¬ìš©) */
        function generateShareLink() {
            try {
                const jsonData = jsonInput.value;

                
                const utf8Bytes = new TextEncoder().encode(jsonData);
                const binaryString = String.fromCodePoint(...utf8Bytes);
                const base64Data = btoa(binaryString).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
                
                
                const shareUrl = `${window.location.origin}${window.location.pathname}#q=${base64Data}`;

                
                const tempInput = document.createElement('textarea');
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                shareLinkBtn.textContent = 'ë§í¬ ë³µì‚¬ ì™„ë£Œ!';
                shareLinkBtn.classList.add('bg-green-200');
                
                setTimeout(() => {
                    shareLinkBtn.textContent = 'ê³µìœ  ë§í¬ ìƒì„±';
                    shareLinkBtn.classList.remove('bg-green-200');
                }, 2000);

            } catch (error) {
                console.error("ê³µìœ  ë§í¬ ìƒì„± ì‹¤íŒ¨:", error);
                alert("ë§í¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (JSON ë°ì´í„°ê°€ ë„ˆë¬´ í´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)");
            }
        }
        
        /** (ì‹ ê·œ) íŒì—…ì°½ ì—´ê³  í€´ì¦ˆ ì‹œì‘ */
        async function startQuizInPopup() {
            try {
                // 1. DBì— í˜„ì¬ í€´ì¦ˆ ë°ì´í„° ì €ì¥
                await saveQuizToDB(QUIZ_ID_KEY, jsonInput.value);
                
                // 2. íŒì—…ì°½ ì—´ê¸°
                quizPopup = window.open(window.location.href, 'quizPopup', 'width=800,height=700,scrollbars=yes,resizable=yes');
                
                if (!quizPopup || quizPopup.closed || typeof quizPopup.closed == 'undefined') {
                    throw new Error("íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
                }

                // 3. ë©”ì¸ì°½ UIë¥¼ 'ëŒ€ê¸° ëª¨ë“œ'ë¡œ ë³€ê²½
                actionControls.classList.add('hidden');
                popupWaitingSection.classList.remove('hidden');
                resultsSection.classList.add('hidden'); // ì´ì „ ê²°ê³¼ ìˆ¨ê¸°ê¸°
                wrongAnswersSection.classList.add('hidden');

                // 4. íŒì—…ì°½ ë‹«í˜ ê°ì§€ ì‹œì‘
                clearInterval(popupCheckInterval); // ì´ì „ ê°ì§€ê¸° ì¤‘ì§€
                popupCheckInterval = setInterval(() => {
                    if (quizPopup && quizPopup.closed) {
                        clearInterval(popupCheckInterval);
                        console.log("íŒì—… ë‹«í˜ ê°ì§€ (ê²°ê³¼ ìˆ˜ì‹  ì „)");
                        // í€´ì¦ˆê°€ ì™„ë£Œë˜ì§€ ì•Šê³  ë‹«íŒ ê²½ìš°
                        if (!resultsSection.classList.contains('hidden')) {
                           // ì´ë¯¸ ê²°ê³¼ê°€ í‘œì‹œë¨ (ì •ìƒ ì¢…ë£Œ)
                        } else {
                           // ë¹„ì •ìƒ ì¢…ë£Œ (Xë²„íŠ¼) -> ëŒ€ê¸° ëª¨ë“œ ì·¨ì†Œ
                           cancelPopupMode();
                        }
                    }
                }, 1000);

            } catch (error) {
                console.error("íŒì—… í€´ì¦ˆ ì‹œì‘ ì‹¤íŒ¨:", error);
                jsonError.textContent = `ì˜¤ë¥˜: ${error.message}`;
                jsonError.classList.remove('hidden');
            }
        }

        /** (ì‹ ê·œ) íŒì—… ëŒ€ê¸° ëª¨ë“œ ì·¨ì†Œ */
        function cancelPopupMode() {
            clearInterval(popupCheckInterval);
            if (quizPopup && !quizPopup.closed) {
                quizPopup.close();
            }
            popupWaitingSection.classList.add('hidden');
            actionControls.classList.remove('hidden'); // ë‹¤ì‹œ ì•¡ì…˜ ë²„íŠ¼ í‘œì‹œ
            resultsSection.classList.add('hidden');
    
            // DB ë°ì´í„° ì‚­ì œ (í€´ì¦ˆ ì·¨ì†Œ)
            deleteQuizFromDB(QUIZ_ID_KEY).catch(err => console.error("DB ì‚­ì œ ì‹¤íŒ¨(ì·¨ì†Œ):", err));
        }

        /** (ì‹ ê·œ) íŒì—…ì—ì„œ ë³´ë‚¸ ë©”ì‹œì§€(ê²°ê³¼) ìˆ˜ì‹  */
        window.addEventListener('message', (event) => {
            // (ë³´ì•ˆ) ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” event.originì„ í™•ì¸í•´ì•¼ í•¨
            // if (event.origin !== window.location.origin) return;

            if (event.data && event.data.type === 'quizResult') {
                const result = event.data.payload;
                console.log("ë©”ì¸ì°½: í€´ì¦ˆ ê²°ê³¼ ìˆ˜ì‹ ", result);
                
                // íŒì—… ê°ì§€ ì¤‘ì§€
                clearInterval(popupCheckInterval);
                
                // 1. ëŒ€ê¸°ì°½ ìˆ¨ê¸°ê¸°
                popupWaitingSection.classList.add('hidden');
                
                // 2. ê²°ê³¼ì°½ í‘œì‹œ
                currentQuiz = result.quizData; // í€´ì¦ˆ ë°ì´í„° ë™ê¸°í™” (í‹€ë¦° ë¬¸ì œ í‘œì‹œìš©)
                const title = currentQuiz.title || "í€´ì¦ˆ";
                if (result.isTimeOut) {
                    resultsTitle.textContent = "â° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤!";
                } else {
                    resultsTitle.textContent = `${title} í€´ì¦ˆ ì™„ë£Œ!`;
                }
                totalQuestionsResult.textContent = `${result.totalQuestions} ë¬¸ì œ`; 
                finalScore.textContent = `${result.score} ê°œ`;

                renderWrongAnswers(currentQuiz, result.wrongAnswers);
                
                resultsSection.classList.remove('hidden');
                
                // 3. 'ì²˜ìŒìœ¼ë¡œ' ë²„íŠ¼ì´ JSON ì…ë ¥ì°½ìœ¼ë¡œ ê°€ë„ë¡ ê¸°ëŠ¥ ìˆ˜ì •
                restartQuizBtn.removeEventListener('click', resetApp);
                restartQuizBtn.addEventListener('click', backToJsonEditor); // (ìˆ˜ì •) ê²°ê³¼ í™•ì¸ í›„ JSON í¸ì§‘ê¸°ë¡œ
            }
        });


        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° (ìˆ˜ì •: async DOMContentLoaded) ---
        window.addEventListener('DOMContentLoaded', async () => { // (ìˆ˜ì •) async ì¶”ê°€
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìš°ì„  ë“±ë¡
            loadJsonBtn.addEventListener('click', loadJsonData);
            resetDefaultJsonBtn.addEventListener('click', () => {
                jsonInput.value = DEFAULT_QUIZ_JSON;
                jsonError.classList.add('hidden');
            });
            copyJsonBtn.addEventListener('click', copyJsonToClipboard);
            clearJsonBtn.addEventListener('click', clearJsonInput);
            
            backToJsonBtn.addEventListener('click', backToJsonEditor);
            shareLinkBtn.addEventListener('click', generateShareLink);
            
            // (ìˆ˜ì •) í€´ì¦ˆ ì‹œì‘ ë²„íŠ¼ -> íŒì—… ë„ìš°ê¸°
            startQuizBtn.addEventListener('click', startQuizInPopup);
            
            printQuestionsBtn.addEventListener('click', printQuestionsOnly);
            printAnswersBtn.addEventListener('click', printAnswersOnly);
            
            // (ìˆ˜ì •) íŒì—… ëŒ€ê¸°ì°½ ë²„íŠ¼
            reopenPopupBtn.addEventListener('click', () => {
                 if (quizPopup && !quizPopup.closed) {
                    quizPopup.focus();
                 } else {
                    // íŒì—…ì´ ë‹«íŒ ê²½ìš° -> ë‹¤ì‹œ ë„ìš°ê¸°
                    quizPopup = window.open(window.location.href, 'quizPopup', 'width=800,height=700,scrollbars=yes,resizable=yes');
                 }
            });
            cancelPopupBtn.addEventListener('click', cancelPopupMode);
            
            quitQuizBtn.addEventListener('click', () => {
                // (ìˆ˜ì •) íŒì—…ì°½ì—ì„œ 'ì²˜ìŒìœ¼ë¡œ'ëŠ” ê·¸ëƒ¥ ì°½ì„ ë‹«ìŒ
                if (window.opener) {
                    window.close();
                } else {
                    resetApp(); // ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” ë¦¬ì…‹
                }
            });
            
            nextQuestionBtn.addEventListener('click', goToNextQuestion);
            restartQuizBtn.addEventListener('click', resetApp); // ê¸°ë³¸: ë¦¬ì…‹ (íŒì—… ê²°ê³¼ ìˆ˜ì‹  ì‹œ ë³€ê²½ë¨)

            // (ì‹ ê·œ) í˜ì´ì§€ ë¡œë“œ ì‹œ URL ë¼ìš°íŒ… ë¡œì§
            try {
                await initDB(); // DBë¶€í„° ì´ˆê¸°í™”

                const hash = window.location.hash;

                if (hash && hash.startsWith('#q=')) {
                    // ì‹œë‚˜ë¦¬ì˜¤ 1: í•´ì‹œ(#q=)ê°€ ìˆìŒ -> DBì— ì €ì¥í•˜ê³  ë¦¬ë‹¤ì´ë ‰íŠ¸
                    await handleHashRedirect(hash);
                    // ë¦¬ë‹¤ì´ë ‰íŠ¸ê°€ ë°œìƒí•˜ë¯€ë¡œ, ì´í›„ ì½”ë“œëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
                
                } else {
                    // ì‹œë‚˜ë¦¬ì˜¤ 2: DBì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸ (íŒì—… ë˜ëŠ” ë¦¬ë‹¤ì´ë ‰íŠ¸)
                    const quizData = await loadQuizFromDB(QUIZ_ID_KEY);
                    // (ì„±ê³µ) DB ë°ì´í„° ì‚­ì œ ë° í€´ì¦ˆ ì‹œì‘
                    await deleteQuizFromDB(QUIZ_ID_KEY);
                    console.log("DBì—ì„œ í€´ì¦ˆ ë¡œë“œ ì„±ê³µ, ë°ì´í„° ì‚­ì œë¨.");
                    
                    jsonInput.value = quizData;
                    loadJsonData(); // í€´ì¦ˆ ë°ì´í„° íŒŒì‹± (UI ì¤€ë¹„)
                    startQuiz();    // í€´ì¦ˆ ì‹œì‘
                
                }
                
            } catch (error) {
                // ì‹œë‚˜ë¦¬ì˜¤ 3: DBì— ë°ì´í„°ê°€ ì—†ìŒ (ì—ëŸ¬ ë˜ëŠ” ì¼ë°˜ ì ‘ì†)
                console.log("DBì— í€´ì¦ˆ ë°ì´í„° ì—†ìŒ, í¸ì§‘ê¸° ëª¨ë“œë¡œ ì‹œì‘:", error.message);
                jsonInput.value = DEFAULT_QUIZ_JSON;
                jsonInputSection.classList.remove('hidden'); // ê¸°ë³¸ í¸ì§‘ê¸° í™”ë©´
            }
        });

    </script>
</body>
</html>
